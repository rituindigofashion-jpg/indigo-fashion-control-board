<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indigo Fashion Control Board - Employee Portal</title>
    <!-- SheetJS Library for Excel Processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Chart.js for beautiful reports & analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --color-bg-dark: #F5F5F0;
            --color-bg-card: rgba(0, 0, 0, 0.03);
            --color-bg-card-hover: rgba(0, 0, 0, 0.06);
            --color-primary: #000000; /* Zara Black */
            --color-primary-dim: #333333;
            --color-text-main: #000000;
            --color-text-muted: #666666;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
            --font-serif: 'Playfair Display', serif;
            --font-sans: 'Inter', sans-serif;
            --glass-border: 1px solid rgba(0, 0, 0, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--color-bg-dark);
            min-height: 100vh;
            color: var(--color-text-main);
            position: relative;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px;
            position: relative;
            z-index: 1;
        }

        /* Header */
        .header {
            background: var(--color-bg-card);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: 24px;
            padding: 24px;
            margin-bottom: 32px;
            box-shadow: var(--glass-shadow);
            border: var(--glass-border);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 24px;
        }

        .logo {
            font-family: var(--font-serif);
            font-size: 28px;
            font-weight: 700;
            color: #000;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
            background: rgba(0,0,0,0.03);
            padding: 8px 16px;
            border-radius: 50px;
            border: var(--glass-border);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dim));
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: 700;
            font-family: var(--font-serif);
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            border-top: var(--glass-border);
            padding-top: 20px;
        }

        .nav-tab {
            padding: 10px 24px;
            border: 1px solid transparent;
            background: transparent;
            color: var(--color-text-muted);
            font-weight: 500;
            font-family: var(--font-sans);
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.2s;
            font-size: 14px;
        }

        .nav-tab:hover {
            background: rgba(0,0,0,0.05);
            color: #000;
        }

        .nav-tab.active {
            background: var(--color-primary);
            color: #fff;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .nav-badge {
            display: inline-block;
            background: var(--color-danger);
            color: #000;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
            min-width: 18px;
            text-align: center;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--color-bg-card);
            border-radius: 24px;
            padding: 24px;
            border: var(--glass-border);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            background: var(--color-bg-card-hover);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .stat-title {
            font-size: 12px;
            color: var(--color-text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-family: var(--font-serif);
            font-size: 32px;
            font-weight: 600;
            color: #000;
        }

        /* Content Card & Tables */
        .content-card {
            background: var(--color-bg-card);
            border-radius: 24px;
            padding: 32px;
            margin-bottom: 32px;
            border: var(--glass-border);
        }

        /* Reports Layout */
        .reports-header-subtitle {
            font-size: 13px;
            color: var(--color-text-muted);
            margin-top: 4px;
        }

        .reports-grid {
            display: grid;
            grid-template-columns: 2fr 2fr;
            gap: 24px;
            margin-top: 24px;
        }

        .report-card {
            background: #ffffff;
            border-radius: 20px;
            padding: 20px 20px 16px 20px;
            border: var(--glass-border);
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.08);
        }

        .report-card.full-width {
            grid-column: span 2;
        }

        .report-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .report-card-title {
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.03em;
            text-transform: uppercase;
            color: var(--color-text-muted);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .report-card-title span {
            font-size: 11px;
            font-weight: 500;
            color: var(--color-text-muted);
            text-transform: none;
        }

        .report-metric-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 16px;
            margin-top: 20px;
            margin-bottom: 4px;
        }

        .report-metric {
            padding: 10px 12px;
            border-radius: 16px;
            background: rgba(0, 0, 0, 0.03);
            border: var(--glass-border);
        }

        .report-metric-label {
            font-size: 11px;
            color: var(--color-text-muted);
            margin-bottom: 4px;
        }

        .report-metric-value {
            font-size: 18px;
            font-weight: 600;
        }

        .report-metric-value.positive {
            color: var(--color-success);
        }

        .report-metric-value.warning {
            color: var(--color-warning);
        }

        .report-metric-value.danger {
            color: var(--color-danger);
        }

        .report-empty-state {
            font-size: 13px;
            color: var(--color-text-muted);
            text-align: center;
            padding: 24px 8px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .card-title {
            font-family: var(--font-serif);
            font-size: 24px;
            font-weight: 600;
            color: #000;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 16px;
            border: var(--glass-border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(0,0,0,0.03);
        }

        th {
            background: rgba(0,0,0,0.03);
            padding: 16px 20px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--color-text-muted);
            letter-spacing: 0.5px;
            border-bottom: var(--glass-border);
        }

        td {
            padding: 16px 20px;
            border-bottom: var(--glass-border);
            font-size: 14px;
            color: #333;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background: rgba(0,0,0,0.02);
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: var(--font-sans);
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--color-primary);
            color: #fff;
        }

        .btn-primary:hover {
            background: #333;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-secondary {
            background: rgba(0,0,0,0.05);
            color: #000;
        }

        .btn-secondary:hover {
            background: rgba(0,0,0,0.08);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 8px;
        }

        /* Forms */
        .form-input, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            background: rgba(0,0,0,0.03);
            border: var(--glass-border);
            border-radius: 12px;
            color: #000;
            font-family: var(--font-sans);
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            color: var(--color-text-muted);
            font-weight: 500;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.25);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #ffffff;
            border: var(--glass-border);
            border-radius: 24px;
            padding: 32px;
            max-width: 640px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px -20px rgba(0, 0, 0, 0.15);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: var(--glass-border);
        }

        .modal-title {
            font-family: var(--font-serif);
            font-size: 24px;
            font-weight: 600;
            color: #000;
        }

        .hidden { display: none !important; }
        
        /* Status Badges */
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .status-approved { background: rgba(16, 185, 129, 0.2); color: #34d399; }
        .status-pending { background: rgba(0, 0, 0, 0.1); color: #000; }
        .status-rejected { background: rgba(239, 68, 68, 0.2); color: #f87171; }

        /* Excel Drop Zone */
        .excel-drop-zone {
            background: var(--color-bg-card);
            border: 2px dashed rgba(0, 0, 0, 0.15);
            border-radius: 24px;
            padding: 40px;
            text-align: center;
            margin-bottom: 32px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .excel-drop-zone:hover {
            border-color: rgba(0, 0, 0, 0.3);
            background: var(--color-bg-card-hover);
            transform: translateY(-2px);
        }

        .excel-drop-zone.drag-over {
            border-color: var(--color-primary);
            background: rgba(0, 0, 0, 0.03);
            box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.05);
        }

        .excel-upload-success {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.5);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--color-success);
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .attendance-highlight {
            animation: highlightFade 2s ease-out;
        }
        
        @keyframes highlightFade {
            from { background: rgba(0, 0, 0, 0.1); }
            to { background: transparent; }
        }

        /* Salary & Deduction Styles */
        .deduction-bar-container {
            margin: 16px 0;
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            border: var(--glass-border);
        }

        .deduction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .deduction-item:last-child {
            margin-bottom: 0;
        }

        .deduction-label {
            font-size: 13px;
            color: var(--color-text-muted);
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 150px;
        }

        .deduction-bar-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0 16px;
        }

        .deduction-bar {
            flex: 1;
            height: 8px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .deduction-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-danger), #f87171);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .deduction-amount {
            font-size: 13px;
            font-weight: 600;
            color: var(--color-text-main);
            min-width: 80px;
            text-align: right;
        }

        .salary-breakdown-card {
            background: var(--color-bg-card);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            border: var(--glass-border);
        }

        .salary-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .salary-item {
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            border: var(--glass-border);
        }

        .salary-item-label {
            font-size: 12px;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .salary-item-value {
            font-family: var(--font-serif);
            font-size: 24px;
            font-weight: 600;
            color: #000;
        }

        .salary-item-value.gross {
            color: var(--color-success);
        }

        .salary-item-value.deductions {
            color: var(--color-danger);
        }

        .salary-item-value.net {
            color: var(--color-primary);
            font-size: 28px;
        }

        .payroll-history-item {
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            border: var(--glass-border);
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .payroll-history-item:hover {
            background: rgba(0, 0, 0, 0.3);
            transform: translateX(4px);
        }

        .payroll-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .payroll-month {
            font-weight: 600;
            color: #000;
            font-size: 16px;
        }

        .payroll-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .payroll-status.paid {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        .payroll-status.pending {
            background: rgba(0, 0, 0, 0.1);
            color: #000;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 3px;
            overflow: hidden;
            margin: 8px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary), var(--color-primary-dim));
            transition: width 0.3s ease;
        }

        @media (max-width: 768px) {
            .container { padding: 16px; }
            .header-content { flex-direction: column; align-items: flex-start; }
            .nav-tabs { overflow-x: auto; padding-bottom: 8px; }
            .dashboard-grid { grid-template-columns: 1fr; }
            .excel-drop-zone { padding: 24px; }
            .deduction-bar-wrapper { flex-direction: column; align-items: stretch; margin: 8px 0; }
            .salary-summary { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <button onclick="logout()" class="btn btn-secondary" style="padding: 8px 12px;" title="Logout">
                        <i data-lucide="log-out" style="width: 16px;"></i> Logout
                    </button>
                    <div class="logo">
                        <i data-lucide="building-2" style="color: var(--color-primary);"></i>
                        Indigo Control Board
                    </div>
                </div>
                <div class="user-info">
                    <div style="text-align: right;">
                        <div style="font-weight: 600; font-size: 14px;">Ritu</div>
                        <div style="font-size: 12px; color: var(--color-text-muted);">HR Administrator</div>
                    </div>
                    <div class="user-avatar">RU</div>
                </div>
            </div>
            
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('dashboard', this)" data-i18n="dashboard">Dashboard</button>
                <button class="nav-tab" onclick="showTab('attendance', this)" data-i18n="attendance">Attendance</button>
                <button class="nav-tab" onclick="showTab('expenses', this)" data-i18n="expenses">Expenses</button>
                <button class="nav-tab" onclick="showTab('salary', this)" data-i18n="salary">
                    <i data-lucide="wallet" style="width: 14px; height: 14px;"></i> Salary
                </button>
                <button class="nav-tab" onclick="showTab('orders', this)" data-i18n="orders">Orders</button>
                <button class="nav-tab" onclick="showTab('employees', this)" data-i18n="employees">Employees</button>
                <button class="nav-tab" onclick="showTab('addExpenseTab', this)" data-i18n="addExpense">
                    <i data-lucide="plus-circle" style="width: 14px; height: 14px;"></i> Add Expense
                </button>
                <button class="nav-tab" onclick="showTab('messages', this)" data-i18n="messages">
                    <i data-lucide="message-circle" style="width: 14px; height: 14px;"></i> Messages
                    <span id="messagesBadge" class="nav-badge" style="display: none;">0</span>
                </button>
                <button class="nav-tab" onclick="showTab('reports', this)" data-i18n="reports">Reports</button>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content">
            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title" data-i18n="employeesPresentToday">Present Today</div>
                        <i data-lucide="users" style="color: var(--color-text-muted); width: 16px;"></i>
                    </div>
                    <div class="stat-value" id="presentTodayCount">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title" data-i18n="lateToday">Late Today</div>
                        <i data-lucide="clock" style="color: var(--color-text-muted); width: 16px;"></i>
                    </div>
                    <div class="stat-value" id="lateTodayCount">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title" data-i18n="pendingExpenseClaims">Pending Claims</div>
                        <i data-lucide="receipt" style="color: var(--color-text-muted); width: 16px;"></i>
                    </div>
                    <div class="stat-value" id="pendingExpensesCount">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title" data-i18n="openOrders">Open Orders</div>
                        <i data-lucide="package" style="color: var(--color-text-muted); width: 16px;"></i>
                    </div>
                    <div class="stat-value" id="openOrdersCount">-</div>
                </div>
                <div class="stat-card" style="background: rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.2);">
                    <div class="stat-header">
                        <div class="stat-title" style="color: var(--color-warning);">Early Leave Today</div>
                        <i data-lucide="log-out" style="color: var(--color-warning); width: 16px;"></i>
                    </div>
                    <div class="stat-value" id="earlyLeaveTodayCount" style="color: var(--color-warning);">-</div>
                </div>
            </div>

            <div class="content-card">
                <div class="card-header">
                    <h3 class="card-title" data-i18n="recentActivities">Recent Activities</h3>
                </div>
                <div class="table-container">
                    <table id="recentActivities">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Employee</th>
                                <th>Type</th>
                                <th>Details</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="activitiesTableBody">
                            <!-- Dynamic content will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Attendance Tab -->
        <div id="attendance" class="tab-content hidden">
            <div class="content-card">
                <div class="card-header">
                    <h3 class="card-title">Attendance Management</h3>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <button class="btn btn-secondary" onclick="exportAttendanceData()">
                            <i data-lucide="download" style="width: 16px;"></i> Export
                        </button>
                        <button class="btn btn-danger" onclick="clearAttendanceData()" style="background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3);">
                            <i data-lucide="trash-2" style="width: 16px;"></i> Clear All
                        </button>
                    </div>
                </div>
                
                <!-- Drag & Drop Excel Upload Zone -->
                <div id="attendanceDropZone" class="excel-drop-zone" style="margin-bottom: 32px; position: relative;">
                    <input type="file" id="attendanceFileInput" accept=".xlsx,.xls" style="display: none;" onchange="handleAttendanceExcel(this.files[0])">
                    <div id="attendanceDropContent">
                        <i data-lucide="calendar-check" style="width: 56px; height: 56px; color: var(--color-primary); margin-bottom: 16px;"></i>
                        <h4 style="margin: 0 0 8px 0; font-size: 20px; color: var(--color-text-main); font-family: var(--font-serif);">Upload Daily Attendance</h4>
                        <p style="margin: 0 0 20px 0; color: var(--color-text-muted); font-size: 14px; max-width: 400px; margin-left: auto; margin-right: auto;">
                            Drag & drop your attendance Excel file here, or click to browse.<br>
                            <span style="font-size: 12px; opacity: 0.7;">New records will be appended to existing data.</span>
                        </p>
                        <button class="btn btn-primary" onclick="document.getElementById('attendanceFileInput').click()" style="padding: 12px 28px;">
                            <i data-lucide="upload" style="width: 18px;"></i> Choose Excel File
                        </button>
                        <p style="margin-top: 16px; font-size: 11px; color: var(--color-text-muted); opacity: 0.7;">
                            Expected format: Name | Date | Clock In | Clock Out | Late | Absent
                        </p>
                    </div>
                    <div id="attendanceUploadProgress" style="display: none;">
                        <div style="width: 60px; height: 60px; border: 4px solid rgba(0, 0, 0, 0.1); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
                        <p style="color: var(--color-text-main); font-size: 16px;">Processing Excel file...</p>
                    </div>
                </div>
                
                <!-- Upload Success Message -->
                <div id="attendanceUploadSuccess" class="excel-upload-success" style="display: none;">
                    <i data-lucide="check-circle" style="width: 24px; height: 24px;"></i>
                    <div>
                        <strong id="attendanceSuccessTitle">Upload Successful!</strong>
                        <p style="margin: 4px 0 0 0; font-size: 13px; opacity: 0.8;" id="attendanceSuccessDetails"></p>
                    </div>
                </div>
                
                <!-- Attendance Summary Cards -->
                <div id="attendanceSummaryCards" class="dashboard-grid" style="margin-bottom: 32px;">
                    <div class="stat-card" style="background: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.2);">
                        <div class="stat-header">
                            <div class="stat-title" style="color: #60a5fa;">Total Records</div>
                        </div>
                        <div class="stat-value" id="attendanceTotalRecords" style="color: #60a5fa;">0</div>
                    </div>
                    <div class="stat-card" style="background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.2);">
                        <div class="stat-header">
                            <div class="stat-title" style="color: #34d399;">Unique Employees</div>
                        </div>
                        <div class="stat-value" id="attendanceUniqueEmployees" style="color: #34d399;">0</div>
                    </div>
                    <div class="stat-card" style="background: rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.2);">
                        <div class="stat-header">
                            <div class="stat-title" style="color: #000;">Late Arrivals</div>
                        </div>
                        <div class="stat-value" id="attendanceLateCount" style="color: #000;">0</div>
                    </div>
                    <div class="stat-card" style="background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.2);">
                        <div class="stat-header">
                            <div class="stat-title" style="color: #f87171;">Last Upload</div>
                        </div>
                        <div class="stat-value" id="attendanceLastUpload" style="color: #f87171; font-size: 18px;">Never</div>
                    </div>
                </div>
                
                <!-- Month Filter -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h4 style="color: var(--color-text-main); font-family: var(--font-serif);">Attendance Records</h4>
                    <select id="attendanceMonth" class="form-input" style="width: auto;" onchange="loadAttendanceTable()">
                        <option value="2025-11">November 2025</option>
                        <option value="2025-12">December 2025</option>
                        <option value="2025-10">October 2025</option>
                    </select>
                </div>
                
                <div class="table-container">
                    <table id="attendanceTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Employee</th>
                                <th>Shift</th>
                                <th>Clock In</th>
                                <th>Clock Out</th>
                                <th>Status</th>
                                <th>Late</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTableBody">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Empty State -->
                <div id="attendanceEmptyState" style="display: none; text-align: center; padding: 60px 20px; color: var(--color-text-muted);">
                    <i data-lucide="calendar-x" style="width: 64px; height: 64px; margin-bottom: 16px; opacity: 0.3;"></i>
                    <h4 style="margin: 0 0 8px 0; color: var(--color-text-main);">No Attendance Records</h4>
                    <p style="margin: 0;">Upload an Excel file to get started</p>
                </div>
            </div>
        </div>

        <!-- Expenses Tab -->
        <div id="expenses" class="tab-content hidden">
            <div class="content-card">
                <div class="card-header">
                    <h3 class="card-title">Expenses & Petty Cash</h3>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="showModal('addReceived')">Add Money</button>
                        <button class="btn btn-primary" onclick="showModal('addExpense')">New Expense</button>
                </div>
                    </div>
                
                <!-- Excel Upload Drop Zone -->
                <div id="excelDropZone" class="excel-drop-zone">
                    <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display: none;" onchange="handleExcelFile(this.files[0])">
                    <i data-lucide="file-spreadsheet" style="width: 48px; height: 48px; color: var(--color-primary); margin-bottom: 12px;"></i>
                    <h4 style="margin: 0 0 8px 0; font-size: 18px; color: var(--color-text-main);">Upload Excel Expenses</h4>
                    <p style="margin: 0 0 16px 0; color: var(--color-text-muted); font-size: 14px;">Drag & drop your Excel file here or click to browse</p>
                    <button class="btn btn-secondary btn-sm" onclick="document.getElementById('excelFileInput').click()">
                        <i data-lucide="upload" style="width: 16px;"></i> Browse File
                    </button>
                    <p style="margin-top: 12px; font-size: 12px; color: var(--color-text-muted);">
                        Excel format: Date | Description | Category | Amount
                    </p>
                    </div>
                
                <!-- Rejection Notifications Section -->
                <div class="content-card" id="rejectionNotificationsSection" style="margin-bottom: 32px;">
                    <div class="card-header">
                        <h3 class="card-title">
                            Rejection Notifications
                            <span id="notificationBadge" class="badge" style="background: var(--color-danger); margin-left: 12px; display: none;">0</span>
                        </h3>
                    </div>
                    <div id="rejectionNotificationsList">
                        <!-- Notifications will be loaded dynamically -->
                        <div id="noNotifications" style="text-align: center; padding: 40px; color: var(--color-text-muted);">
                            <i data-lucide="check-circle" style="width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.3;"></i>
                            <p>No rejection notifications</p>
                        </div>
                    </div>
                </div>
                
                <!-- Summary Cards -->
                <div class="dashboard-grid" style="margin-bottom: 32px;">
                    <div class="stat-card" style="background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.2);">
                        <div class="stat-header">
                            <div class="stat-title" style="color: #34d399;">Total Received</div>
                    </div>
                        <div class="stat-value" id="pettyCashReceived" style="color: #34d399;">৳0</div>
                </div>
                    <div class="stat-card" style="background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.2);">
                        <div class="stat-header">
                            <div class="stat-title" style="color: #f87171;">Total Expenses</div>
                    </div>
                        <div class="stat-value" id="pettyCashExpenses" style="color: #f87171;">৳0</div>
                    </div>
                    <div class="stat-card" style="background: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.2);">
                        <div class="stat-header">
                            <div class="stat-title" style="color: #60a5fa;">Balance</div>
                    </div>
                        <div class="stat-value" id="pettyCashBalance" style="color: #60a5fa;">৳0</div>
                    </div>
                    </div>

                <div class="table-container">
                    <table id="expensesTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th>Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="expensesTableBody">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                    </div>
                </div>
            </div>

        <!-- Salary/Payroll Tab -->
        <div id="salary" class="tab-content hidden">
            <!-- Upload Section -->
            <div class="content-card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i data-lucide="upload" style="width: 20px; height: 20px; vertical-align: middle;"></i>
                        Upload Salary Sheet
                    </h3>
                </div>
                
                <!-- Drag & Drop Zone for Salary Excel -->
                <div id="salaryDropZone" class="drop-zone" style="margin-bottom: 20px;">
                    <div class="drop-zone-content">
                        <i data-lucide="file-spreadsheet" style="width: 48px; height: 48px; color: var(--color-primary); margin-bottom: 16px;"></i>
                        <p style="font-size: 16px; color: var(--color-text); margin-bottom: 8px;">Drag & Drop Salary Excel File</p>
                        <p style="font-size: 13px; color: var(--color-text-muted);">or click to browse (.xlsx, .xls)</p>
                        <input type="file" id="salaryFileInput" accept=".xlsx,.xls" style="display: none;">
                    </div>
                </div>
                <p style="font-size: 12px; color: var(--color-text-muted); text-align: center;">
                    Upload monthly salary sheets. Each upload is saved and can be viewed by selecting the month.
                </p>
            </div>
            
            <!-- Salary View Section -->
            <div class="content-card">
                <div class="card-header">
                    <h3 class="card-title">Salary & Payroll Management</h3>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <select id="salaryMonth" class="form-input" style="width: auto; min-width: 160px;" onchange="loadSalaryData()">
                            <option value="">Select Month</option>
                        </select>
                        <button class="btn btn-primary" onclick="exportSalaryToExcel()" id="exportSalaryBtn" style="display: none;">
                            <i data-lucide="download" style="width: 16px;"></i> Export Excel
                        </button>
                    </div>
                </div>
                
                <!-- Salary Summary Cards -->
                <div class="salary-summary" id="salarySummaryCards" style="display: none;">
                    <div class="salary-item">
                        <div class="salary-item-label">Gross Salary</div>
                        <div class="salary-item-value gross" id="totalGrossSalary">৳0</div>
                        </div>
                    <div class="salary-item">
                        <div class="salary-item-label">Tax Deductions</div>
                        <div class="salary-item-value deductions" id="totalDeductions">৳0</div>
                    </div>
                    <div class="salary-item">
                        <div class="salary-item-label">Net Pay</div>
                        <div class="salary-item-value net" id="totalNetSalary">৳0</div>
                </div>
                    <div class="salary-item">
                        <div class="salary-item-label">Employees</div>
                        <div class="salary-item-value" id="employeesPaid">0</div>
                    </div>
                </div>
                
                <!-- No Data Message -->
                <div id="salaryNoData" style="text-align: center; padding: 60px 20px; color: var(--color-text-muted);">
                    <i data-lucide="file-x" style="width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                    <p style="font-size: 16px; margin-bottom: 8px;">No salary data available</p>
                    <p style="font-size: 13px;">Upload a salary Excel sheet or select a month to view data</p>
            </div>
            
                <!-- Salary Table -->
                <div class="table-container" id="salaryTableContainer" style="display: none;">
                    <table id="salaryTable">
                        <thead>
                            <tr>
                                <th>SL</th>
                                <th>Name</th>
                                <th>Designation</th>
                                <th>Gross Salary</th>
                                <th>Tax Deduction</th>
                                <th>Pay to Cash</th>
                                <th>Pay to Bank</th>
                                <th>Net Pay</th>
                            </tr>
                        </thead>
                        <tbody id="salaryTableBody">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                        </div>
                        </div>
                    </div>
                
        <!-- Orders Tab -->
        <div id="orders" class="tab-content hidden">
            <div class="content-card">
                <div class="card-header">
                    <h3 class="card-title">Orders & Commission Tracking</h3>
                    <button class="btn btn-primary" onclick="showModal('addOrder')">
                        <i data-lucide="plus" style="width: 16px;"></i> Add New Order
                    </button>
                </div>
                
                <!-- Orders Summary -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 16px; padding: 20px;">
                        <div style="font-size: 12px; color: var(--color-text-muted); text-transform: uppercase; margin-bottom: 8px;">Total Orders</div>
                        <div id="totalOrdersCount" style="font-size: 32px; font-weight: 700; color: var(--color-success);">0</div>
                    </div>
                    <div style="background: rgba(0, 0, 0, 0.05); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 16px; padding: 20px;">
                        <div style="font-size: 12px; color: var(--color-text-muted); text-transform: uppercase; margin-bottom: 8px;">Total Commission</div>
                        <div id="totalCommission" style="font-size: 32px; font-weight: 700; color: var(--color-warning);">৳0</div>
                    </div>
                    <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 16px; padding: 20px;">
                        <div style="font-size: 12px; color: var(--color-text-muted); text-transform: uppercase; margin-bottom: 8px;">Pending Shipments</div>
                        <div id="pendingShipments" style="font-size: 32px; font-weight: 700; color: #3b82f6;">0</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="ordersTable">
                        <thead>
                            <tr>
                                <th>Order #</th>
                                <th>Client</th>
                                <th>Factory</th>
                                <th>FOB Value (USD)</th>
                                <th>Factory Cost (USD)</th>
                                <th>Commission (USD)</th>
                                <th>Shipment Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <!-- Dynamic orders -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Employees Tab -->
        <div id="employees" class="tab-content hidden">
            <div class="content-card">
                <div class="card-header">
                    <h3 class="card-title">Employee Directory</h3>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="showModal('addEmployee')">
                            <i data-lucide="user-plus" style="width: 16px;"></i> Add Employee
                        </button>
                        <button class="btn btn-primary" onclick="exportEmployeeDirectory()">
                            <i data-lucide="download" style="width: 16px;"></i> Export Directory
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table id="employeesTable">
                        <thead>
                            <tr>
                                <th>SL</th>
                                <th>Name</th>
                                <th>Designation</th>
                                <th>Department</th>
                                <th>Shift</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="employeesTableBody">
                             <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Add Expense Tab -->
        <div id="addExpenseTab" class="tab-content hidden">
            <div class="content-card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i data-lucide="plus-circle" style="width: 24px; height: 24px; vertical-align: middle;"></i>
                        Submit New Expense
                    </h3>
                    <button class="btn btn-primary" onclick="exportSubmittedExpenses()">
                        <i data-lucide="download" style="width: 16px;"></i> Export All Expenses
                    </button>
                </div>
                <div style="max-width: 600px; margin: 0 auto; padding: 40px 20px;">
                    <form id="quickExpenseForm">
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <input type="text" class="form-input" id="quickExpenseDescription" placeholder="e.g., Transport to factory, Office supplies..." required>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div class="form-group">
                                <label class="form-label">Amount (৳)</label>
                                <input type="number" class="form-input" id="quickExpenseAmount" placeholder="0" required min="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Category</label>
                                <select class="form-input" id="quickExpenseCategory">
                                    <option>Conveyance</option>
                                    <option>Evening Snacks</option>
                                    <option>Buyer's Entertainment</option>
                                    <option>Stationary</option>
                                    <option>Office Expenses</option>
                                    <option>Others</option>
                                </select>
                            </div>
                        </div>

                        <div style="background: rgba(0, 0, 0, 0.05); border: 1px solid rgba(0, 0, 0, 0.15); border-radius: 12px; padding: 16px; margin: 24px 0;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                <i data-lucide="info" style="width: 20px; height: 20px; color: var(--color-warning);"></i>
                                <strong style="color: var(--color-warning);">Auto-Approval Policy</strong>
                            </div>
                            <ul style="color: var(--color-text-muted); font-size: 14px; margin-left: 32px; line-height: 1.6;">
                                <li>Expenses <strong>under ৳5,000</strong> are auto-approved instantly</li>
                                <li>Expenses <strong>৳5,000 or above</strong> require Boss approval</li>
                                <li>Boss receives notification only for high-value expenses</li>
                            </ul>
                        </div>
                        
                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button type="button" class="btn btn-secondary" onclick="showTab('expenses', document.querySelector('[data-i18n=expenses]'))">
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-primary" style="background: var(--color-warning); color: #000;">
                                <i data-lucide="check" style="width: 16px;"></i>
                                Submit Expense
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Messages Tab -->
        <div id="messages" class="tab-content hidden">
            <div class="content-card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i data-lucide="message-circle" style="width: 24px; height: 24px; vertical-align: middle;"></i>
                        Messages from Boss
                    </h3>
                    <button class="btn btn-secondary" onclick="refreshMessages()">
                        <i data-lucide="refresh-cw" style="width: 16px;"></i> Refresh
                    </button>
                </div>

                <!-- Messages List -->
                <div id="messagesList">
                    <!-- Messages will be loaded here dynamically -->
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="tab-content hidden">
            <div class="content-card">
                <div class="card-header">
                    <div>
                        <h3 class="card-title">
                            <i data-lucide="bar-chart-2" style="width: 24px; height: 24px; margin-right: 8px;"></i>
                            Reports &amp; Analytics
                        </h3>
                        <div class="reports-header-subtitle" id="reportsMonthLabel">
                            This month's discipline &amp; expense overview
                        </div>
                    </div>
                </div>

                <!-- Top metrics row -->
                <div class="report-metric-grid">
                    <div class="report-metric">
                        <div class="report-metric-label">Recorded Attendance Days</div>
                        <div class="report-metric-value positive" id="metricTotalAttendance">-</div>
                    </div>
                    <div class="report-metric">
                        <div class="report-metric-label">Late Arrivals</div>
                        <div class="report-metric-value warning" id="metricTotalLate">-</div>
                    </div>
                    <div class="report-metric">
                        <div class="report-metric-label">Early Leaves</div>
                        <div class="report-metric-value warning" id="metricTotalEarlyLeave">-</div>
                    </div>
                    <div class="report-metric">
                        <div class="report-metric-label">UL Days</div>
                        <div class="report-metric-value danger" id="metricTotalUL">-</div>
                    </div>
                </div>

                <!-- Charts grid -->
                <div class="reports-grid">
                    <!-- Attendance Discipline Overview -->
                    <div class="report-card">
                        <div class="report-card-header">
                            <div class="report-card-title">
                                <i data-lucide="activity" style="width: 16px; height: 16px;"></i>
                                Attendance &amp; Discipline
                                <span id="attendanceChartSubtitle"></span>
                            </div>
                        </div>
                        <canvas id="attendanceSummaryChart" height="140"></canvas>
                        <div class="report-empty-state" id="attendanceEmptyState" style="display: none;">
                            No attendance records found for this month yet.
                        </div>
                    </div>

                    <!-- Late Arrivals by Employee -->
                    <div class="report-card">
                        <div class="report-card-header">
                            <div class="report-card-title">
                                <i data-lucide="clock" style="width: 16px; height: 16px;"></i>
                                Late Arrivals by Employee
                                <span id="earlyLeaveChartSubtitle"></span>
                            </div>
                        </div>
                        <canvas id="earlyLeaveChart" height="140"></canvas>
                        <div class="report-empty-state" id="earlyLeaveEmptyState" style="display: none;">
                            No late arrivals recorded for this month. ✨
                        </div>
                    </div>

                    <!-- Expenses by Category -->
                    <div class="report-card full-width">
                        <div class="report-card-header">
                            <div class="report-card-title">
                                <i data-lucide="pie-chart" style="width: 16px; height: 16px;"></i>
                                Expenses by Category
                                <span id="expenseChartSubtitle"></span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 24px; align-items: center; flex-wrap: wrap;">
                            <div style="flex: 1 1 260px; min-width: 240px;">
                                <canvas id="expenseByCategoryChart" height="170"></canvas>
                                <div class="report-empty-state" id="expensesEmptyState" style="display: none;">
                                    No expenses recorded for this month yet.
                                </div>
                            </div>
                            <div style="flex: 1 1 220px; min-width: 220px;">
                                <div class="report-metric" style="margin-bottom: 12px;">
                                    <div class="report-metric-label">Total Expenses This Month</div>
                                    <div class="report-metric-value warning" id="metricTotalExpense">৳0</div>
                                </div>
                                <div class="report-metric" style="margin-bottom: 12px;">
                                    <div class="report-metric-label">High-Value Expenses (≥ ৳5,000)</div>
                                    <div class="report-metric-value" id="metricHighValueCount">0</div>
                                </div>
                                <div class="report-metric">
                                    <div class="report-metric-label">Low-Value Expenses (&lt; ৳5,000)</div>
                                    <div class="report-metric-value" id="metricLowValueCount">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Expense Modal -->
    <div id="addExpenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Submit Expense</h2>
                <button onclick="hideModal('addExpense')" class="btn btn-secondary btn-sm"><i data-lucide="x" style="width: 16px;"></i></button>
            </div>
            <form id="addExpenseForm">
                    <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-input" id="expenseDescription" required>
                    </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">Amount (৳)</label>
                        <input type="number" class="form-input" id="expenseAmount" required>
                </div>
                <div class="form-group">
                        <label class="form-label">Category</label>
                        <select class="form-input" id="expenseCategory">
                            <option>Conveyance</option>
                            <option>Evening Snacks</option>
                            <option>Buyer's Entertainment</option>
                            <option>Stationary</option>
                            <option>Office Expenses</option>
                            <option>Others</option>
                        </select>
                </div>
                        </div>
                <div style="margin-top: 24px; display: flex; justify-content: flex-end; gap: 12px;">
                    <button type="button" class="btn btn-secondary" onclick="hideModal('addExpense')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Submit</button>
                </div>
            </form>
        </div>
                </div>
                
    <!-- Add Received Modal -->
    <div id="addReceivedModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Funds</h2>
                <button onclick="hideModal('addReceived')" class="btn btn-secondary btn-sm"><i data-lucide="x" style="width: 16px;"></i></button>
                        </div>
            <form id="addReceivedForm">
                        <div class="form-group">
                    <label class="form-label">Amount (৳)</label>
                    <input type="number" class="form-input" id="receivedAmount" required>
                        </div>
                        <div class="form-group">
                    <label class="form-label">Source</label>
                    <input type="text" class="form-input" id="receivedFrom" placeholder="e.g. Bank Withdrawal" required>
                        </div>
                 <div style="margin-top: 24px; display: flex; justify-content: flex-end; gap: 12px;">
                    <button type="button" class="btn btn-secondary" onclick="hideModal('addReceived')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Funds</button>
                        </div>
            </form>
                        </div>
                        </div>
    
    <!-- Add Attendance Modal -->
    <div id="addAttendanceModal" class="modal">
         <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Record Attendance</h2>
                <button onclick="hideModal('addAttendance')" class="btn btn-secondary btn-sm"><i data-lucide="x" style="width: 16px;"></i></button>
                    </div>
             <form id="addAttendanceForm">
                 <!-- Simply placeholder form for now -->
                 <p style="color: var(--color-text-muted);">Manual attendance entry form.</p>
                 <div style="margin-top: 24px; display: flex; justify-content: flex-end; gap: 12px;">
                    <button type="button" class="btn btn-secondary" onclick="hideModal('addAttendance')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
             </form>
         </div>
                </div>

    <!-- Process Payroll Modal -->
    <div id="processPayrollModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Process Payroll</h2>
                <button onclick="hideModal('processPayroll')" class="btn btn-secondary btn-sm"><i data-lucide="x" style="width: 16px;"></i></button>
            </div>
            <form id="processPayrollForm">
                <div class="form-group">
                    <label class="form-label">Month</label>
                    <select class="form-input" id="payrollMonth" required>
                        <option value="2024-11">November 2024</option>
                        <option value="2024-10">October 2024</option>
                        <option value="2024-09">September 2024</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Payment Date</label>
                    <input type="date" class="form-input" id="paymentDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Payment Method</label>
                    <select class="form-input" id="paymentMethod" required>
                        <option>Bank Transfer</option>
                        <option>Cash</option>
                        <option>Check</option>
                    </select>
                </div>
                <div style="margin-top: 24px; display: flex; justify-content: flex-end; gap: 12px;">
                    <button type="button" class="btn btn-secondary" onclick="hideModal('processPayroll')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Process Payroll</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Order Modal -->
    <div id="addOrderModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">Add New Order</h2>
                <button onclick="hideModal('addOrder')" class="btn btn-secondary btn-sm"><i data-lucide="x" style="width: 16px;"></i></button>
            </div>
            <form id="addOrderForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">Order Number *</label>
                        <input type="text" class="form-input" id="orderNumber" placeholder="e.g., ORD-2025-001" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Shipment Date *</label>
                        <input type="date" class="form-input" id="orderShipmentDate" required>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">Client Name *</label>
                        <input type="text" class="form-input" id="orderClientName" placeholder="e.g., Global Fashion Inc" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Factory Name *</label>
                        <input type="text" class="form-input" id="orderFactoryName" placeholder="e.g., ABC Garments Ltd" required>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">FOB Value (Client Price) USD *</label>
                        <input type="number" class="form-input" id="orderFobValue" placeholder="e.g., 50000" required min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Factory Cost USD *</label>
                        <input type="number" class="form-input" id="orderFactoryCost" placeholder="e.g., 42000" required min="0" step="0.01">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">Agent Name (if any)</label>
                        <input type="text" class="form-input" id="orderAgentName" placeholder="e.g., XYZ Trading">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Agent Commission (%)</label>
                        <input type="number" class="form-input" id="orderAgentCommission" placeholder="e.g., 3" min="0" max="100" step="0.1" value="0">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-input" id="orderStatus">
                        <option value="Pending">Pending</option>
                        <option value="Cleared">Cleared</option>
                    </select>
                </div>
                
                <!-- Commission Preview -->
                <div style="background: rgba(0, 0, 0, 0.05); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 12px; padding: 16px; margin: 16px 0;">
                    <div style="font-size: 12px; color: var(--color-text-muted); margin-bottom: 8px;">Commission Preview</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; text-align: center;">
                        <div>
                            <div style="font-size: 11px; color: var(--color-text-muted);">Gross Margin</div>
                            <div id="previewGrossMargin" style="font-size: 18px; font-weight: 700; color: #000;">$0</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: var(--color-text-muted);">Agent Fee</div>
                            <div id="previewAgentFee" style="font-size: 18px; font-weight: 700; color: var(--color-danger);">-$0</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: var(--color-text-muted);">Net Commission</div>
                            <div id="previewNetCommission" style="font-size: 18px; font-weight: 700; color: var(--color-success);">$0</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 24px; display: flex; justify-content: flex-end; gap: 12px;">
                    <button type="button" class="btn btn-secondary" onclick="hideModal('addOrder')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Order</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Employee Modal -->
    <div id="addEmployeeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Employee</h2>
                <button onclick="hideModal('addEmployee')" class="btn btn-secondary btn-sm"><i data-lucide="x" style="width: 16px;"></i></button>
            </div>
            <form id="addEmployeeForm">
                    <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" class="form-input" id="employeeName" required>
                    </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <input type="text" class="form-input" id="employeeRole" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Department</label>
                        <select class="form-input" id="employeeDepartment" required>
                            <option>HR</option>
                            <option>Admin</option>
                            <option>Merchandising</option>
                            <option>Accounts</option>
                            <option>Operations</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Monthly Salary (৳)</label>
                    <input type="number" class="form-input" id="employeeSalary" required>
                </div>
                <div style="margin-top: 24px; display: flex; justify-content: flex-end; gap: 12px;">
                    <button type="button" class="btn btn-secondary" onclick="hideModal('addEmployee')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Employee</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ===== SUPABASE CONFIGURATION =====
        const SUPABASE_URL = 'https://jynkhlaykzcztvadvbpf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5bmtobGF5a3pjenR2YWR2YnBmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2ODMyMjQsImV4cCI6MjA4MDI1OTIyNH0.4TKAMWSdUr1aut5CCS46FiP3RdsWMpV16xNxbvJzw2c';

        let supabaseClient = null;
        let supabaseAvailable = false;

        if (typeof window.supabase !== 'undefined') {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            window.checkSupabaseConnection = async function() {
                try {
                    const { data, error } = await supabaseClient.from('employees').select('count');
                    if (error) throw error;
                    console.log('✅ Supabase connected successfully!');
                    supabaseAvailable = true;
                    return true;
                } catch (e) {
                    console.warn('⚠️ Supabase not available, falling back to localStorage');
                    supabaseAvailable = false;
                    return false;
                }
            };
            
            window.addEventListener('load', () => checkSupabaseConnection());
        }
        // ===== END SUPABASE CONFIG =====

        // ============================================
        // SUPABASE DATA LAYER FUNCTIONS
        // ============================================

        // ===== ATTENDANCE FUNCTIONS =====
        
        // Insert attendance records to Supabase (batch with UPSERT)
        async function insertAttendanceToSupabase(records) {
            if (!supabaseAvailable) return { success: false, error: 'Supabase not available' };
            
            try {
                // Parse and format records
                const formattedRecords = records.map(r => ({
                    employee_name: (r.name || r.employee_name || '').toUpperCase(),
                    date: parseDate(r.date),
                    clock_in: r.clockIn || r.clock_in || null,
                    clock_out: r.clockOut || r.clock_out || null,
                    late_time: r.late || r.late_time || '',
                    absent_type: r.absent || r.absent_type || null
                }));

                const { data, error } = await supabaseClient
                    .from('attendance')
                    .upsert(formattedRecords, { 
                        onConflict: 'employee_name,date',
                        ignoreDuplicates: false 
                    });

                if (error) throw error;
                console.log(`✅ Inserted ${formattedRecords.length} attendance records`);
                return { success: true, data, count: formattedRecords.length };
            } catch (error) {
                console.error('❌ Error inserting attendance:', error);
                return { success: false, error: error.message };
            }
        }

        // Get attendance from Supabase
        async function getAttendanceFromSupabase(month, year) {
            if (!supabaseAvailable) return [];
            
            try {
                let query = supabaseClient.from('attendance').select('*');
                
                if (month && year) {
                    const startDate = `${year}-${String(month).padStart(2, '0')}-01`;
                    const endDate = `${year}-${String(month).padStart(2, '0')}-31`;
                    query = query.gte('date', startDate).lte('date', endDate);
                }
                
                const { data, error } = await query.order('date', { ascending: false });
                
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('❌ Error fetching attendance:', error);
                return [];
            }
        }

        // Get attendance by employee
        async function getAttendanceByEmployeeFromSupabase(employeeName, startDate, endDate) {
            if (!supabaseAvailable) return [];
            
            try {
                let query = supabaseClient
                    .from('attendance')
                    .select('*')
                    .eq('employee_name', employeeName.toUpperCase());
                
                if (startDate) query = query.gte('date', startDate);
                if (endDate) query = query.lte('date', endDate);
                
                const { data, error } = await query.order('date', { ascending: false });
                
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('❌ Error fetching employee attendance:', error);
                return [];
            }
        }

        // ===== EXPENSE FUNCTIONS =====
        
        // Insert expenses to Supabase (batch)
        async function insertExpensesToSupabase(expenses) {
            if (!supabaseAvailable) return { success: false, error: 'Supabase not available' };
            
            try {
                const formattedExpenses = expenses.map(e => ({
                    employee_name: e.employee || e.employee_name || null,
                    description: e.description || '',
                    amount: parseFloat(e.amount) || 0,
                    category: e.category || 'Others',
                    date: parseDate(e.date),
                    status: e.amount < 5000 ? 'Auto-Approved' : 'Pending'
                }));

                const { data, error } = await supabaseClient
                    .from('expenses')
                    .insert(formattedExpenses);

                if (error) throw error;
                console.log(`✅ Inserted ${formattedExpenses.length} expenses`);
                return { success: true, data, count: formattedExpenses.length };
            } catch (error) {
                console.error('❌ Error inserting expenses:', error);
                return { success: false, error: error.message };
            }
        }

        // Get expenses from Supabase
        async function getExpensesFromSupabase(filters = {}) {
            if (!supabaseAvailable) return [];
            
            try {
                let query = supabaseClient.from('expenses').select('*');
                
                if (filters.status) query = query.eq('status', filters.status);
                if (filters.category) query = query.eq('category', filters.category);
                if (filters.employee) query = query.eq('employee_name', filters.employee);
                if (filters.startDate) query = query.gte('date', filters.startDate);
                if (filters.endDate) query = query.lte('date', filters.endDate);
                
                const { data, error } = await query.order('date', { ascending: false });
                
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('❌ Error fetching expenses:', error);
                return [];
            }
        }

        // Approve expense in Supabase
        async function approveExpenseInSupabase(expenseId, approvedBy = 'Boss') {
            if (!supabaseAvailable) return { success: false };
            
            try {
                const { data, error } = await supabaseClient
                    .from('expenses')
                    .update({ 
                        status: 'Approved',
                        approved_by: approvedBy,
                        approved_at: new Date().toISOString()
                    })
                    .eq('id', expenseId);

                if (error) throw error;
                console.log(`✅ Approved expense ${expenseId}`);
                return { success: true, data };
            } catch (error) {
                console.error('❌ Error approving expense:', error);
                return { success: false, error: error.message };
            }
        }

        // Reject expense in Supabase
        async function rejectExpenseInSupabase(expenseId, reason, rejectedBy = 'Boss') {
            if (!supabaseAvailable) return { success: false };
            
            try {
                const { data, error } = await supabaseClient
                    .from('expenses')
                    .update({ 
                        status: 'Rejected',
                        rejection_reason: reason,
                        approved_by: rejectedBy,
                        approved_at: new Date().toISOString()
                    })
                    .eq('id', expenseId);

                if (error) throw error;
                console.log(`✅ Rejected expense ${expenseId}`);
                return { success: true, data };
            } catch (error) {
                console.error('❌ Error rejecting expense:', error);
                return { success: false, error: error.message };
            }
        }

        // ===== EMPLOYEE FUNCTIONS =====
        
        // Get employees from Supabase
        async function getEmployeesFromSupabase(includeLeft = true) {
            if (!supabaseAvailable) return [];
            
            try {
                let query = supabaseClient.from('employees').select('*');
                
                if (!includeLeft) {
                    query = query.eq('status', 'active');
                }
                
                const { data, error } = await query.order('name', { ascending: true });
                
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('❌ Error fetching employees:', error);
                return [];
            }
        }

        // Insert employee to Supabase
        async function insertEmployeeToSupabase(employee) {
            if (!supabaseAvailable) return { success: false };
            
            try {
                const { data, error } = await supabaseClient
                    .from('employees')
                    .insert({
                        name: employee.name,
                        department: employee.department || null,
                        shift: employee.shift || 'Second Shift',
                        monthly_salary: employee.monthlySalary || employee.monthly_salary || 0,
                        status: employee.status || 'active'
                    });

                if (error) throw error;
                console.log(`✅ Inserted employee: ${employee.name}`);
                return { success: true, data };
            } catch (error) {
                console.error('❌ Error inserting employee:', error);
                return { success: false, error: error.message };
            }
        }

        // Update employee in Supabase
        async function updateEmployeeInSupabase(employeeId, updates) {
            if (!supabaseAvailable) return { success: false };
            
            try {
                const { data, error } = await supabaseClient
                    .from('employees')
                    .update(updates)
                    .eq('id', employeeId);

                if (error) throw error;
                console.log(`✅ Updated employee ${employeeId}`);
                return { success: true, data };
            } catch (error) {
                console.error('❌ Error updating employee:', error);
                return { success: false, error: error.message };
            }
        }

        // ===== ORDER FUNCTIONS =====
        
        // Insert orders to Supabase
        async function insertOrdersToSupabase(orders) {
            if (!supabaseAvailable) return { success: false };
            
            try {
                const formattedOrders = orders.map(o => ({
                    order_number: o.orderNumber || o.order_number,
                    buyer: o.buyer,
                    style: o.style,
                    quantity: o.quantity,
                    fob_price: o.fobPrice || o.fob_price,
                    total_value: o.totalValue || o.total_value || (o.quantity * (o.fobPrice || o.fob_price)),
                    commission_rate: o.commissionRate || o.commission_rate || 1.00,
                    commission_amount: o.commissionAmount || o.commission_amount || (o.totalValue || o.total_value) * 0.01,
                    status: o.status || 'Pending',
                    order_date: parseDate(o.orderDate || o.order_date || o.date)
                }));

                const { data, error } = await supabaseClient
                    .from('orders')
                    .upsert(formattedOrders, { onConflict: 'order_number' });

                if (error) throw error;
                console.log(`✅ Inserted ${formattedOrders.length} orders`);
                return { success: true, data, count: formattedOrders.length };
            } catch (error) {
                console.error('❌ Error inserting orders:', error);
                return { success: false, error: error.message };
            }
        }

        // Get orders from Supabase
        async function getOrdersFromSupabase(status = null) {
            if (!supabaseAvailable) return [];
            
            try {
                let query = supabaseClient.from('orders').select('*');
                
                if (status) query = query.eq('status', status);
                
                const { data, error } = await query.order('order_date', { ascending: false });
                
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('❌ Error fetching orders:', error);
                return [];
            }
        }

        // Update order status
        async function updateOrderStatusInSupabase(orderId, status) {
            if (!supabaseAvailable) return { success: false };
            
            try {
                const { data, error } = await supabaseClient
                    .from('orders')
                    .update({ status })
                    .eq('id', orderId);

                if (error) throw error;
                console.log(`✅ Updated order ${orderId} to ${status}`);
                return { success: true, data };
            } catch (error) {
                console.error('❌ Error updating order:', error);
                return { success: false, error: error.message };
            }
        }

        // ===== MESSAGE FUNCTIONS =====
        
        // Insert message to Supabase
        async function insertMessageToSupabase(message) {
            if (!supabaseAvailable) return { success: false };
            
            try {
                const { data, error } = await supabaseClient
                    .from('messages')
                    .insert({
                        sender: message.sender,
                        content: message.content,
                        reply_to: message.replyTo || message.reply_to || null,
                        read: false
                    });

                if (error) throw error;
                console.log(`✅ Sent message from ${message.sender}`);
                return { success: true, data };
            } catch (error) {
                console.error('❌ Error sending message:', error);
                return { success: false, error: error.message };
            }
        }

        // Get messages from Supabase
        async function getMessagesFromSupabase() {
            if (!supabaseAvailable) return [];
            
            try {
                const { data, error } = await supabaseClient
                    .from('messages')
                    .select('*')
                    .order('timestamp', { ascending: false });

                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('❌ Error fetching messages:', error);
                return [];
            }
        }

        // Mark message as read
        async function markMessageAsReadInSupabase(messageId) {
            if (!supabaseAvailable) return { success: false };
            
            try {
                const { data, error } = await supabaseClient
                    .from('messages')
                    .update({ read: true })
                    .eq('id', messageId);

                if (error) throw error;
                return { success: true, data };
            } catch (error) {
                console.error('❌ Error marking message as read:', error);
                return { success: false, error: error.message };
            }
        }

        // ===== SALARY FUNCTIONS =====
        
        // Calculate and save salary from attendance
        async function calculateSalaryFromSupabase(employeeName, month, year) {
            if (!supabaseAvailable) return { success: false };
            
            try {
                // Get employee details
                const { data: employee, error: empError } = await supabaseClient
                    .from('employees')
                    .select('*')
                    .eq('name', employeeName.toUpperCase())
                    .single();

                if (empError) throw empError;

                // Get attendance for the month
                const startDate = `${year}-${String(month).padStart(2, '0')}-01`;
                const endDate = `${year}-${String(month).padStart(2, '0')}-31`;
                
                const { data: attendance, error: attError } = await supabaseClient
                    .from('attendance')
                    .select('*')
                    .eq('employee_name', employeeName.toUpperCase())
                    .gte('date', startDate)
                    .lte('date', endDate);

                if (attError) throw attError;

                // Calculate deductions
                const lateDays = attendance.filter(a => a.is_late).length;
                const ulDays = attendance.filter(a => a.absent_type === 'UL').length;
                const alDays = attendance.filter(a => a.absent_type === 'AL').length;
                const earlyLeaveDays = attendance.filter(a => a.is_early_leave).length;

                const dailySalary = employee.monthly_salary / 26;
                const lateDeduction = Math.floor(lateDays / 3) * dailySalary;
                const ulDeduction = ulDays * dailySalary;
                const netSalary = employee.monthly_salary - lateDeduction - ulDeduction;

                // Insert/update salary record
                const monthDate = `${year}-${String(month).padStart(2, '0')}-01`;
                
                const { data: salaryData, error: salError } = await supabaseClient
                    .from('salary')
                    .upsert({
                        employee_name: employeeName.toUpperCase(),
                        month: monthDate,
                        base_salary: employee.monthly_salary,
                        late_days: lateDays,
                        late_deduction: lateDeduction,
                        ul_days: ulDays,
                        ul_deduction: ulDeduction,
                        al_days: alDays,
                        early_leave_days: earlyLeaveDays,
                        net_salary: netSalary,
                        status: 'Pending'
                    }, { onConflict: 'employee_name,month' });

                if (salError) throw salError;

                console.log(`✅ Calculated salary for ${employeeName}`);
                return { 
                    success: true, 
                    salary: {
                        baseSalary: employee.monthly_salary,
                        lateDays,
                        lateDeduction,
                        ulDays,
                        ulDeduction,
                        alDays,
                        earlyLeaveDays,
                        netSalary
                    }
                };
            } catch (error) {
                console.error('❌ Error calculating salary:', error);
                return { success: false, error: error.message };
            }
        }

        // Get salary records
        async function getSalaryRecordsFromSupabase(month, year) {
            if (!supabaseAvailable) return [];
            
            try {
                const monthDate = `${year}-${String(month).padStart(2, '0')}-01`;
                
                const { data, error } = await supabaseClient
                    .from('salary')
                    .select('*')
                    .eq('month', monthDate)
                    .order('employee_name', { ascending: true });

                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('❌ Error fetching salary records:', error);
                return [];
            }
        }

        // ===== HELPER FUNCTIONS =====
        
        // Parse various date formats to YYYY-MM-DD
        function parseDate(dateStr) {
            if (!dateStr) return null;
            
            // Already in YYYY-MM-DD format
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                return dateStr;
            }
            
            // Format: DD-MMM-YY (e.g., "03-Nov-25")
            if (/^\d{2}-[A-Za-z]{3}-\d{2}$/.test(dateStr)) {
                const [day, monthStr, year] = dateStr.split('-');
                const monthMap = {
                    'Jan': '01', 'Feb': '02', 'Mar': '03', 'Apr': '04',
                    'May': '05', 'Jun': '06', 'Jul': '07', 'Aug': '08',
                    'Sep': '09', 'Oct': '10', 'Nov': '11', 'Dec': '12'
                };
                const fullYear = `20${year}`;
                return `${fullYear}-${monthMap[monthStr]}-${day}`;
            }
            
            // Try parsing as Date object
            try {
                const d = new Date(dateStr);
                if (!isNaN(d.getTime())) {
                    return d.toISOString().split('T')[0];
                }
            } catch (e) {
                console.warn('Could not parse date:', dateStr);
            }
            
            return null;
        }

        // ============================================
        // END SUPABASE DATA LAYER
        // ============================================

        lucide.createIcons();
        
        // ============================================
        // LOCALSTORAGE HELPER FUNCTIONS
        // ============================================
        
        // Generate unique expense ID using timestamp
        function generateExpenseId() {
            return Date.now();
        }
        
        // Save or update expense in localStorage
        function saveExpenseToStorage(expense) {
            const expenses = getExpensesFromStorage();
            const existingIndex = expenses.findIndex(e => e.id === expense.id);
            
            if (existingIndex !== -1) {
                expenses[existingIndex] = expense;
            } else {
                expenses.push(expense);
            }
            
            localStorage.setItem('indigoExpenses', JSON.stringify(expenses));
        }
        
        // Get all expenses from localStorage
        function getExpensesFromStorage() {
            const stored = localStorage.getItem('indigoExpenses');
            return stored ? JSON.parse(stored) : [];
        }
        
        // Save rejection notification for Ritu
        function saveRejectionNotification(notification) {
            const notifications = getRejectionNotifications(true); // Get all, not just unread
            notifications.push(notification);
            localStorage.setItem('indigoNotifications', JSON.stringify(notifications));
        }
        
        // Get rejection notifications (unread only by default)
        function getRejectionNotifications(includeRead = false) {
            const stored = localStorage.getItem('indigoNotifications');
            const all = stored ? JSON.parse(stored) : [];
            return includeRead ? all : all.filter(n => !n.read);
        }
        
        // Mark rejection notification as read
        function markRejectionNotificationRead(id) {
            const notifications = getRejectionNotifications(true);
            const notification = notifications.find(n => n.id === id);
            if (notification) {
                notification.read = true;
                localStorage.setItem('indigoNotifications', JSON.stringify(notifications));
            }
        }
        
        // Save boss notification
        function saveBossNotification(notification) {
            const notifications = getBossNotifications(true); // Get all
            notifications.push(notification);
            localStorage.setItem('indigoBossNotifications', JSON.stringify(notifications));
        }
        
        // Get boss notifications
        function getBossNotifications(includeViewed = false) {
            const stored = localStorage.getItem('indigoBossNotifications');
            const all = stored ? JSON.parse(stored) : [];
            return includeViewed ? all : all.filter(n => !n.viewed);
        }
        
        // ============================================
        // MESSAGING SYSTEM
        // ============================================
        
        // Get all messages
        function getMessages() {
            const stored = localStorage.getItem('indigoMessages');
            const messages = stored ? JSON.parse(stored) : [];
    return messages.filter(msg => !msg.message || !msg.message.includes('nigga balls'));
        }
        
        // Save message
        function saveMessage(message) {
            const messages = getMessages();
            messages.push(message);
            localStorage.setItem('indigoMessages', JSON.stringify(messages));
        }
        
        // Mark message as read
        function markMessageAsRead(messageId) {
            const messages = getMessages();
            const message = messages.find(m => m.id === messageId);
            if (message) {
                message.read = true;
                localStorage.setItem('indigoMessages', JSON.stringify(messages));
            }
        }
        
        // Get unread message count
        function getUnreadMessageCount() {
            const messages = getMessages();
            return messages.filter(m => m.to === 'employee' && !m.read).length;
        }
        
        // ============================================
        // DATA MODELS (Reconstructed from context)
        // ============================================
        
        // ============================================
        // SHIFT ASSIGNMENT CONFIGURATION
        // ============================================
        const FIRST_SHIFT_EMPLOYEES = ["Ritu", "Shila", "Arnab", "Badiul"];
        const FIRST_SHIFT_START = { hour: 9, minute: 0 }; // 9:00 AM
        const FIRST_SHIFT_END = { hour: 19, minute: 0 }; // 7:00 PM
        const SECOND_SHIFT_START = { hour: 10, minute: 30 }; // 10:30 AM
        const SECOND_SHIFT_END = { hour: 20, minute: 30 }; // 8:30 PM
        const GRACE_PERIOD_MINUTES = 15;
        
        // Helper: Get employee shift (1 = First Shift, 2 = Second Shift)
        function getEmployeeShift(employeeName) {
            return FIRST_SHIFT_EMPLOYEES.includes(employeeName) ? 1 : 2;
        }
        
        // Helper: Check if employee is late based on clock-in time and shift
        function isLate(clockInTime, employeeName) {
            if (!clockInTime) return false;
            
            const shift = getEmployeeShift(employeeName);
            const clockIn = new Date(clockInTime);
            const clockInHour = clockIn.getHours();
            const clockInMinute = clockIn.getMinutes();
            
            if (shift === 1) {
                // First Shift: Late if > 9:15 AM
                const lateTime = FIRST_SHIFT_START.hour * 60 + FIRST_SHIFT_START.minute + GRACE_PERIOD_MINUTES;
                const clockInMinutes = clockInHour * 60 + clockInMinute;
                return clockInMinutes > lateTime;
            } else {
                // Second Shift: Late if > 10:45 AM
                const lateTime = SECOND_SHIFT_START.hour * 60 + SECOND_SHIFT_START.minute + GRACE_PERIOD_MINUTES;
                const clockInMinutes = clockInHour * 60 + clockInMinute;
                return clockInMinutes > lateTime;
            }
        }
        
        // Helper: Check if employee left early
        function isEarlyLeave(clockOutTime, employeeName) {
            if (!clockOutTime) return false;
            
            const shift = getEmployeeShift(employeeName);
            const clockOut = new Date(clockOutTime);
            const clockOutHour = clockOut.getHours();
            const clockOutMinute = clockOut.getMinutes();
            
            if (shift === 1) {
                // First Shift: Early if < 7:00 PM
                const shiftEndMinutes = FIRST_SHIFT_END.hour * 60 + FIRST_SHIFT_END.minute;
                const clockOutMinutes = clockOutHour * 60 + clockOutMinute;
                return clockOutMinutes < shiftEndMinutes;
            } else {
                // Second Shift: Early if < 8:30 PM
                const shiftEndMinutes = SECOND_SHIFT_END.hour * 60 + SECOND_SHIFT_END.minute;
                const clockOutMinutes = clockOutHour * 60 + clockOutMinute;
                return clockOutMinutes < shiftEndMinutes;
            }
        }
        
        // Helper: Format time from date
        function formatTime(dateTime) {
            if (!dateTime) return "-";
            const d = new Date(dateTime);
            const hours = d.getHours();
            const minutes = d.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours % 12 || 12;
            return `${displayHours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')} ${ampm}`;
        }
        
        // Helper: Calculate late deduction (3 late days = 1 day salary)
        function calculateLateDeductionForEmployee(employee, attendanceRecords, month) {
            const monthRecords = attendanceRecords.filter(r => {
                const recordDate = new Date(r.date);
                return recordDate.getMonth() === month.getMonth() && 
                       recordDate.getFullYear() === month.getFullYear() &&
                       r.employeeId === employee.id;
            });
            
            const lateDays = monthRecords.filter(r => {
                if (r.status === "Late") return true;
                if (r.clockInTime && isLate(r.clockInTime, employee.name)) return true;
                return false;
            }).length;
            
            const daysDeducted = Math.floor(lateDays / 3);
            const dailySalary = employee.monthlySalary / (employee.workingDaysInMonth || 26);
            return {
                lateDays: lateDays,
                daysDeducted: daysDeducted,
                deductionAmount: daysDeducted * dailySalary
            };
        }
        
        // Helper: Calculate early leave days for display
        function calculateEarlyLeaveDays(employee, attendanceRecords, month) {
            const monthRecords = attendanceRecords.filter(r => {
                const recordDate = new Date(r.date);
                return recordDate.getMonth() === month.getMonth() && 
                       recordDate.getFullYear() === month.getFullYear() &&
                       r.employeeId === employee.id;
            });
            
            return monthRecords.filter(r => {
                if (r.earlyLeave) return true;
                if (r.clockOutTime && isEarlyLeave(r.clockOutTime, employee.name)) return true;
                return false;
            }).length;
        }
        
        // Helper: Calculate total deductions (late + UL)
        function calculateTotalDeductionsForEmployee(employee, attendanceRecords, month) {
            const lateDeduction = calculateLateDeductionForEmployee(employee, attendanceRecords, month);
            const monthRecords = attendanceRecords.filter(r => {
                const recordDate = new Date(r.date);
                return recordDate.getMonth() === month.getMonth() && 
                       recordDate.getFullYear() === month.getFullYear() &&
                       r.employeeId === employee.id;
            });
            
            // Count UL days (Unauthorized Leave = full day deducted)
            const ulDays = monthRecords.filter(r => r.status === "Absent" && r.leaveType === "UL").length;
            const dailySalary = employee.monthlySalary / (employee.workingDaysInMonth || 26);
            const ulDeduction = ulDays * dailySalary;
            
            return {
                lateDays: lateDeduction.lateDays,
                lateDeduction: lateDeduction.deductionAmount,
                ulDays: ulDays,
                ulDeduction: ulDeduction,
                earlyLeaveDays: calculateEarlyLeaveDays(employee, attendanceRecords, month),
                totalDeduction: lateDeduction.deductionAmount + ulDeduction
            };
        }
        
        // Default employees list (will be merged with localStorage)
        const defaultEmployees = [
            { id: 1, name: "Ritu", role: "HR Administrator", department: "HR", monthlySalary: 35000, advance: 5000, workingDaysInMonth: 26, payrollStatus: "pending", status: "active", shift: 1 },
            { id: 2, name: "Shila", role: "Office Executive", department: "Admin", monthlySalary: 28000, advance: 2000, workingDaysInMonth: 26, payrollStatus: "pending", status: "active", shift: 1 },
            { id: 3, name: "Arnab", role: "Merchandiser", department: "Merchandising", monthlySalary: 40000, advance: 0, workingDaysInMonth: 26, payrollStatus: "pending", status: "active", shift: 1 },
            { id: 4, name: "Badiul", role: "Accountant", department: "Accounts", monthlySalary: 32000, advance: 3000, workingDaysInMonth: 26, payrollStatus: "paid", status: "left", shift: 1, leftDate: "2025-12-31", leftReason: "Resigned" },
            { id: 5, name: "Kalam", role: "Merchandiser", department: "Merchandising", monthlySalary: 38000, advance: 0, workingDaysInMonth: 26, payrollStatus: "pending", status: "active", shift: 2 },
            { id: 6, name: "Azad", role: "Office Assistant", department: "Admin", monthlySalary: 22000, advance: 0, workingDaysInMonth: 26, payrollStatus: "pending", status: "active", shift: 2 }
        ];
        
        // Get employees from localStorage (with defaults)
        function getEmployeesFromStorage() {
            const stored = localStorage.getItem('indigoEmployees');
            if (stored) {
                return JSON.parse(stored);
            }
            // First time: save default employees to localStorage
            localStorage.setItem('indigoEmployees', JSON.stringify(defaultEmployees));
            return defaultEmployees;
        }
        
        // Save employees to localStorage
        function saveEmployeesToStorage(employeesList) {
            localStorage.setItem('indigoEmployees', JSON.stringify(employeesList));
        }
        
        // Add new employee
        function addEmployee(employee) {
            const employeesList = getEmployeesFromStorage();
            const newId = Math.max(...employeesList.map(e => e.id), 0) + 1;
            employee.id = newId;
            employee.status = 'active';
            employee.payrollStatus = 'pending';
            employee.workingDaysInMonth = 26;
            employeesList.push(employee);
            saveEmployeesToStorage(employeesList);
            return employee;
        }
        
        // Remove employee (mark as "left" - keeps historical data)
        function removeEmployee(employeeId, reason = 'Resigned') {
            const employeesList = getEmployeesFromStorage();
            const index = employeesList.findIndex(e => e.id === employeeId);
            if (index !== -1) {
                employeesList[index].status = 'left';
                employeesList[index].leftDate = new Date().toISOString().split('T')[0];
                employeesList[index].leftReason = reason;
                saveEmployeesToStorage(employeesList);
                return true;
            }
            return false;
        }
        
        // Permanently delete employee (use with caution)
        function deleteEmployeePermanently(employeeId) {
            const employeesList = getEmployeesFromStorage();
            const filtered = employeesList.filter(e => e.id !== employeeId);
            saveEmployeesToStorage(filtered);
        }
        
        // Update employee
        function updateEmployee(updatedEmployee) {
            const employeesList = getEmployeesFromStorage();
            const index = employeesList.findIndex(e => e.id === updatedEmployee.id);
            if (index !== -1) {
                employeesList[index] = { ...employeesList[index], ...updatedEmployee };
                saveEmployeesToStorage(employeesList);
                return true;
            }
            return false;
        }
        
        // Reinstate employee (if they return)
        function reinstateEmployee(employeeId) {
            const employeesList = getEmployeesFromStorage();
            const index = employeesList.findIndex(e => e.id === employeeId);
            if (index !== -1) {
                employeesList[index].status = 'active';
                delete employeesList[index].leftDate;
                delete employeesList[index].leftReason;
                saveEmployeesToStorage(employeesList);
                return true;
            }
            return false;
        }
        
        // Initialize employees from localStorage
        let employees = getEmployeesFromStorage();

        // Get orders from localStorage
        function getOrdersFromStorage() {
            const stored = localStorage.getItem('indigoOrders');
            if (stored) {
                return JSON.parse(stored);
            }
            return [];
        }
        
        // Save order to localStorage
        function saveOrderToStorage(order) {
            const orders = getOrdersFromStorage();
            orders.push(order);
            localStorage.setItem('indigoOrders', JSON.stringify(orders));
        }
        
        // Update order in localStorage
        function updateOrderInStorage(updatedOrder) {
            const orders = getOrdersFromStorage();
            const index = orders.findIndex(o => o.id === updatedOrder.id);
            if (index !== -1) {
                orders[index] = updatedOrder;
                localStorage.setItem('indigoOrders', JSON.stringify(orders));
            }
        }
        
        // Delete order from localStorage
        function deleteOrderFromStorage(orderId) {
            const orders = getOrdersFromStorage();
            const filtered = orders.filter(o => o.id !== orderId);
            localStorage.setItem('indigoOrders', JSON.stringify(filtered));
        }
        
        // Calculate order commission
        function calculateOrderCommission(order) {
            const grossMargin = order.fobValue - order.factoryCost;
            const agentFee = order.fobValue * (order.agentCommission / 100);
            const netCommission = grossMargin - agentFee;
            return {
                grossMargin,
                agentFee,
                netCommission
            };
        }

        // Daily Expenses from Excel (Daily Expense.xlsx) - REAL DATA ONLY
        // Total: 88 records | TOTAL AMOUNT: ৳1,239,958
        let dailyExpenses = [
            { id: 1, date: "2025-11-03", description: "Delivery charge for sir's parcel", amount: 80, type: "daily", category: "Conveyance" },
            { id: 2, date: "2025-11-03", description: "5 days salary for Office assistant Hasib", amount: 2500, type: "daily", category: "Others" },
            { id: 3, date: "2025-11-03", description: "Office to AIBL to office", amount: 120, type: "daily", category: "Conveyance" },
            { id: 4, date: "2025-11-01", description: "Evening snacks", amount: 310, type: "daily", category: "Evening Snacks" },
            { id: 5, date: "2025-11-02", description: "Office to Brac bank Nabisco to office", amount: 260, type: "daily", category: "Conveyance" },
            { id: 6, date: "2025-11-03", description: "Vegetables for sir's house", amount: 130, type: "daily", category: "Others" },
            { id: 7, date: "2025-11-03", description: "Office to Brac bank Nabisco to office", amount: 200, type: "daily", category: "Conveyance" },
            { id: 8, date: "2025-11-03", description: "Scoch tape 1 dzn", amount: 100, type: "daily", category: "Stationary" },
            { id: 9, date: "2025-11-03", description: "Lunch for NRN guest", amount: 260, type: "daily", category: "Evening Snacks" },
            { id: 10, date: "2025-11-03", description: "Internet bill of November-25", amount: 2100, type: "daily", category: "Office Expenses" },
            { id: 11, date: "2025-11-03", description: "Evening snacks", amount: 310, type: "daily", category: "Evening Snacks" },
            { id: 12, date: "2025-11-03", description: "Ginger and tea bag", amount: 120, type: "daily", category: "Office Expenses" },
            { id: 13, date: "2025-11-02", description: "Elevated expressway toll and parking", amount: 100, type: "daily", category: "Conveyance" },
            { id: 14, date: "2025-11-04", description: "Elevated expressway toll 3 times", amount: 240, type: "daily", category: "Conveyance" },
            { id: 15, date: "2025-11-04", description: "DBBL salary for the month of October-25", amount: 879639, type: "daily", category: "Others" },
            { id: 16, date: "2025-11-05", description: "Mondal Express bill of Oct-25", amount: 29000, type: "daily", category: "Others" },
            { id: 17, date: "2025-11-05", description: "BRTA commission", amount: 500, type: "daily", category: "Office Expenses" },
            { id: 18, date: "2025-11-05", description: "Conveyance", amount: 170, type: "daily", category: "Conveyance" },
            { id: 19, date: "2025-11-05", description: "Office rent for October-25", amount: 50000, type: "daily", category: "Others" },
            { id: 20, date: "2025-11-05", description: "Loan to Mr. Sabbir", amount: 50000, type: "daily", category: "Others" },
            { id: 21, date: "2025-11-05", description: "Salary of Mr. Bodiul for October-25", amount: 25000, type: "daily", category: "Others" },
            { id: 22, date: "2025-11-05", description: "Salary of Mr. Maidul Islam for October-25", amount: 25000, type: "daily", category: "Others" },
            { id: 23, date: "2025-11-05", description: "Salary of Mr. Kalam for October-25", amount: 15000, type: "daily", category: "Others" },
            { id: 24, date: "2025-11-05", description: "Salary of Mr. Sumon for October-25", amount: 48334, type: "daily", category: "Others" },
            { id: 25, date: "2025-11-05", description: "Salary of Mrs. Ranu for October-25", amount: 6000, type: "daily", category: "Others" },
            { id: 26, date: "2025-11-05", description: "Salary of Nayem for October-25", amount: 13000, type: "daily", category: "Others" },
            { id: 27, date: "2025-11-03", description: "Salary of Mr. Rafiqul Islam (Caretaker)", amount: 14000, type: "daily", category: "Others" },
            { id: 28, date: "2025-11-05", description: "Electricity", amount: 17000, type: "daily", category: "Office Expenses" },
            { id: 29, date: "2025-11-05", description: "Salary tax", amount: 19390, type: "daily", category: "Others" },
            { id: 30, date: "2025-11-05", description: "Salary of Mr.Nahid for October-25", amount: 5000, type: "daily", category: "Others" },
            { id: 31, date: "2025-11-04", description: "Evening snacks", amount: 300, type: "daily", category: "Evening Snacks" },
            { id: 32, date: "2025-11-05", description: "Evening snacks", amount: 350, type: "daily", category: "Evening Snacks" },
            { id: 33, date: "2025-11-06", description: "Cinamon and Tejpata", amount: 230, type: "daily", category: "Office Expenses" },
            { id: 34, date: "2025-11-06", description: "Evening snacks", amount: 680, type: "daily", category: "Evening Snacks" },
            { id: 35, date: "2025-11-07", description: "Tea set 1 dzn for Mr. Sushil", amount: 9230, type: "daily", category: "Buyer's Entertainment" },
            { id: 36, date: "2025-11-08", description: "3 seal and colour pad", amount: 360, type: "daily", category: "Stationary" },
            { id: 37, date: "2025-11-08", description: "Sheet protector 100pcs", amount: 320, type: "daily", category: "Stationary" },
            { id: 38, date: "2025-11-08", description: "Tissue box 20 pcs", amount: 1500, type: "daily", category: "Stationary" },
            { id: 39, date: "2025-11-08", description: "Kitchen tissue 4 pcs", amount: 300, type: "daily", category: "Stationary" },
            { id: 40, date: "2025-11-08", description: "Stapler machine 1 pc", amount: 150, type: "daily", category: "Stationary" },
            { id: 41, date: "2025-11-08", description: "Office file 12 pcs", amount: 145, type: "daily", category: "Stationary" },
            { id: 42, date: "2025-11-08", description: "Pen 1 dzn", amount: 55, type: "daily", category: "Stationary" },
            { id: 43, date: "2025-11-08", description: "Eraser 5 and sharpner 5", amount: 100, type: "daily", category: "Stationary" },
            { id: 44, date: "2025-11-08", description: "Air freshner", amount: 250, type: "daily", category: "Office Expenses" },
            { id: 45, date: "2025-11-08", description: "Binder clip 2 box", amount: 125, type: "daily", category: "Stationary" },
            { id: 46, date: "2025-11-08", description: "Large file 6 pcs", amount: 600, type: "daily", category: "Stationary" },
            { id: 47, date: "2025-11-08", description: "Naplin tissue 6 pcs", amount: 390, type: "daily", category: "Stationary" },
            { id: 48, date: "2025-11-08", description: "james clip", amount: 50, type: "daily", category: "Stationary" },
            { id: 49, date: "2025-11-10", description: "Lifebouy handwash 1 ltr", amount: 380, type: "daily", category: "Office Expenses" },
            { id: 50, date: "2025-11-11", description: "Evening snacks", amount: 455, type: "daily", category: "Evening Snacks" },
            { id: 51, date: "2025-11-10", description: "BGBA amendment fee", amount: 2050, type: "daily", category: "Others" },
            { id: 52, date: "2025-11-09", description: "Elevated expressway toll", amount: 80, type: "daily", category: "Conveyance" },
            { id: 53, date: "2025-11-07", description: "Vim+Stainer", amount: 70, type: "daily", category: "Office Expenses" },
            { id: 54, date: "2025-11-07", description: "Evening snacks", amount: 350, type: "daily", category: "Evening Snacks" },
            { id: 55, date: "2025-11-07", description: "Office to rajakkhi to Azampur to office", amount: 80, type: "daily", category: "Conveyance" },
            { id: 56, date: "2025-11-08", description: "Evening snacks", amount: 360, type: "daily", category: "Evening Snacks" },
            { id: 57, date: "2025-11-10", description: "Office to Brac bank Nabisco to office", amount: 200, type: "daily", category: "Conveyance" },
            { id: 58, date: "2025-11-11", description: "Ginger", amount: 30, type: "daily", category: "Office Expenses" },
            { id: 59, date: "2025-11-10", description: "Evening snacks", amount: 330, type: "daily", category: "Evening Snacks" },
            { id: 60, date: "2025-11-10", description: "Milk", amount: 20, type: "daily", category: "Office Expenses" },
            { id: 61, date: "2025-11-12", description: "Office to Banani for parcel sending to Mr. Sushil to office", amount: 320, type: "daily", category: "Conveyance" },
            { id: 62, date: "2025-11-12", description: "Office to Brac bank Nabisco to office", amount: 200, type: "daily", category: "Conveyance" },
            { id: 63, date: "2025-11-12", description: "Evening snacks", amount: 310, type: "daily", category: "Evening Snacks" },
            { id: 64, date: "2025-11-13", description: "Advance salary", amount: 1000, type: "daily", category: "Others" },
            { id: 65, date: "2025-11-05", description: "1 Case water bottle", amount: 280, type: "daily", category: "Office Expenses" },
            { id: 66, date: "2025-11-13", description: "Office to Gulshan -1 to offic eby pathao", amount: 425, type: "daily", category: "Conveyance" },
            { id: 67, date: "2025-11-13", description: "Office to Azampur to office", amount: 40, type: "daily", category: "Conveyance" },
            { id: 68, date: "2025-11-13", description: "Evening snacks", amount: 330, type: "daily", category: "Evening Snacks" },
            { id: 69, date: "2025-11-14", description: "Evening snacks", amount: 350, type: "daily", category: "Evening Snacks" },
            { id: 70, date: "2025-11-14", description: "Tea bag ,ginger and sugar", amount: 250, type: "daily", category: "Office Expenses" },
            { id: 71, date: "2025-11-14", description: "Mobile bill", amount: 500, type: "daily", category: "Office Expenses" },
            { id: 72, date: "2025-11-17", description: "Fuel for sir's car", amount: 2000, type: "daily", category: "Others" },
            { id: 73, date: "2025-11-17", description: "Flowers", amount: 1550, type: "daily", category: "Others" },
            { id: 74, date: "2025-11-17", description: "Office to Azampur to office", amount: 50, type: "daily", category: "Conveyance" },
            { id: 75, date: "2025-11-17", description: "2 Coke", amount: 260, type: "daily", category: "Others" },
            { id: 76, date: "2025-11-17", description: "Sweets", amount: 3010, type: "daily", category: "Others" },
            { id: 77, date: "2025-11-17", description: "Day labour ,chemical,rickshaw", amount: 1130, type: "daily", category: "Others" },
            { id: 78, date: "2025-11-16", description: "Evening snacks", amount: 390, type: "daily", category: "Evening Snacks" },
            { id: 79, date: "2025-11-16", description: "Arav's coaching up down", amount: 60, type: "daily", category: "Conveyance" },
            { id: 80, date: "2025-11-17", description: "Cucumber and lemon", amount: 300, type: "daily", category: "Office Expenses" },
            { id: 81, date: "2025-11-17", description: "Sir's house to office with heavy plate", amount: 20, type: "daily", category: "Conveyance" },
            { id: 82, date: "2025-11-17", description: "Arav's coaching up down", amount: 60, type: "daily", category: "Conveyance" },
            { id: 83, date: "2025-11-18", description: "ABC parcel release from chaina", amount: 2800, type: "daily", category: "Others" },
            { id: 84, date: "2025-11-13", description: "Elevated expressway toll", amount: 80, type: "daily", category: "Conveyance" },
            { id: 85, date: "2025-11-15", description: "Elevated expressway toll 3 times", amount: 240, type: "daily", category: "Conveyance" },
            { id: 86, date: "2025-11-16", description: "Elevated  expressway toll", amount: 80, type: "daily", category: "Conveyance" },
            { id: 87, date: "2025-11-17", description: "Parking toll", amount: 100, type: "daily", category: "Conveyance" },
            { id: 88, date: "2025-11-18", description: "Advance for toll", amount: 420, type: "daily", category: "Conveyance" }
        ];
        
        // Pending Expenses - Empty by default (new expenses added via Add Expense form)
        let expenses = [];

        // ============================================
        // COMPLETE NOVEMBER 2025 ATTENDANCE DATA (201 records)
        // From: Attendance of Nov-2025 (2).xlsx
        // Last day: Nov 29, 2025 (10 employees)
        // ============================================
        const novemberAttendanceData = [
            { name: "RITU", date: "2025-11-03", clockIn: "09:02", clockOut: "", late: "", absent: "" },
            { name: "RITU", date: "2025-11-05", clockIn: "09:10", clockOut: "19:04", late: "", absent: "" },
            { name: "RITU", date: "2025-11-06", clockIn: "09:02", clockOut: "20:19", late: "", absent: "" },
            { name: "RITU", date: "2025-11-07", clockIn: "09:10", clockOut: "19:01", late: "", absent: "" },
            { name: "RITU", date: "2025-11-08", clockIn: "09:04", clockOut: "19:02", late: "", absent: "" },
            { name: "RITU", date: "2025-11-10", clockIn: "08:58", clockOut: "19:21", late: "", absent: "" },
            { name: "RITU", date: "2025-11-11", clockIn: "08:48", clockOut: "19:04", late: "", absent: "" },
            { name: "RITU", date: "2025-11-12", clockIn: "09:03", clockOut: "19:04", late: "", absent: "" },
            { name: "RITU", date: "2025-11-13", clockIn: "09:00", clockOut: "19:11", late: "", absent: "" },
            { name: "RITU", date: "2025-11-15", clockIn: "09:02", clockOut: "19:19", late: "", absent: "" },
            { name: "RITU", date: "2025-11-17", clockIn: "08:51", clockOut: "18:47", late: "", absent: "" },
            { name: "RITU", date: "2025-11-18", clockIn: "08:57", clockOut: "17:49", late: "", absent: "" },
            { name: "RITU", date: "2025-11-19", clockIn: "08:51", clockOut: "20:33", late: "", absent: "" },
            { name: "RITU", date: "2025-11-20", clockIn: "08:55", clockOut: "18:28", late: "", absent: "" },
            { name: "RITU", date: "2025-11-21", clockIn: "08:59", clockOut: "19:06", late: "", absent: "" },
            { name: "RITU", date: "2025-11-22", clockIn: "08:56", clockOut: "17:07", late: "", absent: "" },
            { name: "RITU", date: "2025-11-25", clockIn: "09:07", clockOut: "19:05", late: "", absent: "" },
            { name: "RITU", date: "2025-11-26", clockIn: "09:03", clockOut: "19:06", late: "", absent: "" },
            { name: "RITU", date: "2025-11-27", clockIn: "09:03", clockOut: "19:06", late: "", absent: "" },
            { name: "RITU", date: "2025-11-28", clockIn: "08:56", clockOut: "19:03", late: "", absent: "" },
            { name: "RITU", date: "2025-11-29", clockIn: "09:06", clockOut: "19:29", late: "", absent: "" },
            { name: "AZAD", date: "2025-11-01", clockIn: "09:25", clockOut: "19:24", late: "00:10", absent: "" },
            { name: "AZAD", date: "2025-11-03", clockIn: "10:47", clockOut: "20:13", late: "01:32", absent: "" },
            { name: "AZAD", date: "2025-11-04", clockIn: "10:37", clockOut: "20:16", late: "01:22", absent: "" },
            { name: "AZAD", date: "2025-11-05", clockIn: "10:28", clockOut: "20:25", late: "01:13", absent: "" },
            { name: "AZAD", date: "2025-11-06", clockIn: "10:42", clockOut: "20:22", late: "01:27", absent: "" },
            { name: "AZAD", date: "2025-11-08", clockIn: "09:13", clockOut: "19:33", late: "", absent: "" },
            { name: "AZAD", date: "2025-11-10", clockIn: "09:42", clockOut: "", late: "00:27", absent: "" },
            { name: "AZAD", date: "2025-11-11", clockIn: "10:25", clockOut: "20:13", late: "01:10", absent: "" },
            { name: "AZAD", date: "2025-11-12", clockIn: "10:20", clockOut: "20:08", late: "01:05", absent: "" },
            { name: "AZAD", date: "2025-11-13", clockIn: "09:08", clockOut: "19:28", late: "", absent: "" },
            { name: "AZAD", date: "2025-11-14", clockIn: "10:24", clockOut: "", late: "01:09", absent: "" },
            { name: "AZAD", date: "2025-11-17", clockIn: "10:31", clockOut: "20:12", late: "01:16", absent: "" },
            { name: "AZAD", date: "2025-11-18", clockIn: "10:18", clockOut: "", late: "01:03", absent: "" },
            { name: "AZAD", date: "2025-11-20", clockIn: "11:14", clockOut: "", late: "01:59", absent: "" },
            { name: "AZAD", date: "2025-11-22", clockIn: "09:48", clockOut: "18:58", late: "00:33", absent: "" },
            { name: "AZAD", date: "2025-11-24", clockIn: "10:37", clockOut: "21:37", late: "01:22", absent: "" },
            { name: "AZAD", date: "2025-11-25", clockIn: "09:26", clockOut: "21:27", late: "00:11", absent: "" },
            { name: "AZAD", date: "2025-11-26", clockIn: "10:21", clockOut: "", late: "01:06", absent: "" },
            { name: "AZAD", date: "2025-11-28", clockIn: "10:33", clockOut: "20:33", late: "01:18", absent: "" },
            { name: "AZAD", date: "2025-11-29", clockIn: "10:00", clockOut: "18:40", late: "00:45", absent: "" },
            { name: "SABBIR", date: "2025-11-01", clockIn: "08:53", clockOut: "18:58", late: "", absent: "" },
            { name: "SABBIR", date: "2025-11-03", clockIn: "10:36", clockOut: "", late: "01:21", absent: "" },
            { name: "SABBIR", date: "2025-11-05", clockIn: "12:10", clockOut: "", late: "02:55", absent: "" },
            { name: "SABBIR", date: "2025-11-07", clockIn: "10:25", clockOut: "20:24", late: "01:10", absent: "" },
            { name: "SABBIR", date: "2025-11-08", clockIn: "08:56", clockOut: "19:45", late: "", absent: "" },
            { name: "SABBIR", date: "2025-11-10", clockIn: "10:45", clockOut: "20:43", late: "01:30", absent: "" },
            { name: "SABBIR", date: "2025-11-11", clockIn: "10:22", clockOut: "20:32", late: "01:07", absent: "" },
            { name: "SABBIR", date: "2025-11-12", clockIn: "10:38", clockOut: "20:08", late: "01:23", absent: "" },
            { name: "SABBIR", date: "2025-11-13", clockIn: "08:40", clockOut: "20:11", late: "", absent: "" },
            { name: "SABBIR", date: "2025-11-14", clockIn: "10:19", clockOut: "20:39", late: "01:04", absent: "" },
            { name: "SABBIR", date: "2025-11-15", clockIn: "09:01", clockOut: "", late: "", absent: "" },
            { name: "SABBIR", date: "2025-11-18", clockIn: "10:08", clockOut: "", late: "00:53", absent: "" },
            { name: "SABBIR", date: "2025-11-20", clockIn: "11:11", clockOut: "20:23", late: "01:56", absent: "" },
            { name: "SABBIR", date: "2025-11-22", clockIn: "09:28", clockOut: "18:56", late: "00:13", absent: "" },
            { name: "SABBIR", date: "2025-11-25", clockIn: "10:17", clockOut: "20:39", late: "01:02", absent: "" },
            { name: "SABBIR", date: "2025-11-26", clockIn: "10:18", clockOut: "", late: "01:03", absent: "" },
            { name: "SABBIR", date: "2025-11-28", clockIn: "10:19", clockOut: "", late: "01:04", absent: "" },
            { name: "KALAM", date: "2025-11-01", clockIn: "09:18", clockOut: "18:58", late: "", absent: "" },
            { name: "KALAM", date: "2025-11-03", clockIn: "10:22", clockOut: "20:16", late: "01:07", absent: "" },
            { name: "KALAM", date: "2025-11-04", clockIn: "10:29", clockOut: "20:28", late: "01:14", absent: "" },
            { name: "KALAM", date: "2025-11-05", clockIn: "10:27", clockOut: "20:24", late: "01:12", absent: "" },
            { name: "KALAM", date: "2025-11-06", clockIn: "10:43", clockOut: "16:57", late: "01:28", absent: "" },
            { name: "KALAM", date: "2025-11-07", clockIn: "10:30", clockOut: "20:24", late: "01:15", absent: "" },
            { name: "KALAM", date: "2025-11-08", clockIn: "09:07", clockOut: "19:46", late: "", absent: "" },
            { name: "KALAM", date: "2025-11-10", clockIn: "10:35", clockOut: "20:41", late: "01:20", absent: "" },
            { name: "KALAM", date: "2025-11-11", clockIn: "10:32", clockOut: "20:32", late: "01:17", absent: "" },
            { name: "KALAM", date: "2025-11-12", clockIn: "10:27", clockOut: "20:09", late: "01:12", absent: "" },
            { name: "KALAM", date: "2025-11-13", clockIn: "09:07", clockOut: "20:11", late: "", absent: "" },
            { name: "KALAM", date: "2025-11-14", clockIn: "10:34", clockOut: "20:39", late: "01:19", absent: "" },
            { name: "KALAM", date: "2025-11-15", clockIn: "09:16", clockOut: "", late: "", absent: "" },
            { name: "KALAM", date: "2025-11-18", clockIn: "10:26", clockOut: "20:25", late: "01:11", absent: "" },
            { name: "KALAM", date: "2025-11-19", clockIn: "10:27", clockOut: "20:34", late: "01:12", absent: "" },
            { name: "KALAM", date: "2025-11-20", clockIn: "10:25", clockOut: "20:23", late: "01:10", absent: "" },
            { name: "KALAM", date: "2025-11-21", clockIn: "10:48", clockOut: "20:32", late: "01:33", absent: "" },
            { name: "KALAM", date: "2025-11-22", clockIn: "09:30", clockOut: "18:57", late: "00:15", absent: "" },
            { name: "KALAM", date: "2025-11-24", clockIn: "10:29", clockOut: "20:34", late: "01:14", absent: "" },
            { name: "KALAM", date: "2025-11-25", clockIn: "10:25", clockOut: "20:39", late: "01:10", absent: "" },
            { name: "KALAM", date: "2025-11-27", clockIn: "10:25", clockOut: "20:24", late: "01:10", absent: "" },
            { name: "KALAM", date: "2025-11-29", clockIn: "09:29", clockOut: "19:30", late: "00:14", absent: "" },
            { name: "SHARIF", date: "2025-11-01", clockIn: "08:22", clockOut: "17:34", late: "", absent: "" },
            { name: "SHARIF", date: "2025-11-03", clockIn: "10:31", clockOut: "20:16", late: "01:16", absent: "" },
            { name: "SHARIF", date: "2025-11-04", clockIn: "10:17", clockOut: "20:40", late: "01:02", absent: "" },
            { name: "SHARIF", date: "2025-11-05", clockIn: "10:14", clockOut: "19:14", late: "00:59", absent: "" },
            { name: "SHARIF", date: "2025-11-06", clockIn: "10:37", clockOut: "21:36", late: "01:22", absent: "" },
            { name: "SHARIF", date: "2025-11-07", clockIn: "08:59", clockOut: "22:55", late: "", absent: "" },
            { name: "SHARIF", date: "2025-11-10", clockIn: "10:09", clockOut: "20:59", late: "00:54", absent: "" },
            { name: "SHARIF", date: "2025-11-11", clockIn: "10:21", clockOut: "20:40", late: "01:06", absent: "" },
            { name: "SHARIF", date: "2025-11-12", clockIn: "10:18", clockOut: "20:39", late: "01:03", absent: "" },
            { name: "SHARIF", date: "2025-11-13", clockIn: "08:18", clockOut: "", late: "", absent: "" },
            { name: "SHARIF", date: "2025-11-15", clockIn: "09:00", clockOut: "", late: "", absent: "" },
            { name: "SHARIF", date: "2025-11-18", clockIn: "10:28", clockOut: "20:25", late: "01:13", absent: "" },
            { name: "SHARIF", date: "2025-11-19", clockIn: "09:47", clockOut: "19:07", late: "00:32", absent: "" },
            { name: "SHARIF", date: "2025-11-21", clockIn: "10:31", clockOut: "21:30", late: "01:16", absent: "" },
            { name: "SHARIF", date: "2025-11-22", clockIn: "08:09", clockOut: "", late: "", absent: "" },
            { name: "SHARIF", date: "2025-11-25", clockIn: "08:53", clockOut: "19:02", late: "", absent: "" },
            { name: "SHARIF", date: "2025-11-26", clockIn: "10:21", clockOut: "22:43", late: "01:06", absent: "" },
            { name: "SHARIF", date: "2025-11-27", clockIn: "10:18", clockOut: "22:41", late: "01:03", absent: "" },
            { name: "SHARIF", date: "2025-11-28", clockIn: "08:28", clockOut: "22:07", late: "", absent: "" },
            { name: "SHARIF", date: "2025-11-29", clockIn: "08:01", clockOut: "", late: "", absent: "" },
            { name: "NAYEM", date: "2025-11-01", clockIn: "09:18", clockOut: "19:01", late: "", absent: "" },
            { name: "NAYEM", date: "2025-11-04", clockIn: "09:04", clockOut: "", late: "", absent: "" },
            { name: "NAYEM", date: "2025-11-11", clockIn: "09:18", clockOut: "", late: "", absent: "" },
            { name: "NAYEM", date: "2025-11-22", clockIn: "11:57", clockOut: "18:58", late: "02:42", absent: "" },
            { name: "NAYEM", date: "2025-11-26", clockIn: "08:47", clockOut: "", late: "", absent: "" },
            { name: "SHILA", date: "2025-11-06", clockIn: "09:14", clockOut: "19:01", late: "", absent: "" },
            { name: "SHILA", date: "2025-11-07", clockIn: "09:04", clockOut: "19:01", late: "", absent: "" },
            { name: "SHILA", date: "2025-11-08", clockIn: "09:05", clockOut: "19:02", late: "", absent: "" },
            { name: "SHILA", date: "2025-11-10", clockIn: "10:21", clockOut: "19:21", late: "01:06", absent: "" },
            { name: "SHILA", date: "2025-11-11", clockIn: "09:19", clockOut: "19:04", late: "", absent: "" },
            { name: "SHILA", date: "2025-11-12", clockIn: "09:13", clockOut: "19:04", late: "", absent: "" },
            { name: "SHILA", date: "2025-11-13", clockIn: "09:07", clockOut: "19:11", late: "", absent: "" },
            { name: "SHILA", date: "2025-11-14", clockIn: "09:25", clockOut: "19:04", late: "00:10", absent: "" },
            { name: "SHILA", date: "2025-11-15", clockIn: "09:17", clockOut: "", late: "", absent: "" },
            { name: "SHILA", date: "2025-11-19", clockIn: "09:39", clockOut: "", late: "00:24", absent: "" },
            { name: "SHILA", date: "2025-11-20", clockIn: "11:28", clockOut: "19:05", late: "02:13", absent: "" },
            { name: "SHILA", date: "2025-11-21", clockIn: "09:23", clockOut: "19:06", late: "", absent: "" },
            { name: "SHILA", date: "2025-11-22", clockIn: "09:05", clockOut: "16:13", late: "", absent: "" },
            { name: "SHILA", date: "2025-11-24", clockIn: "09:15", clockOut: "19:07", late: "", absent: "" },
            { name: "SHILA", date: "2025-11-25", clockIn: "09:18", clockOut: "19:05", late: "", absent: "" },
            { name: "SHILA", date: "2025-11-26", clockIn: "09:08", clockOut: "19:06", late: "", absent: "" },
            { name: "SHILA", date: "2025-11-27", clockIn: "09:13", clockOut: "19:06", late: "", absent: "" },
            { name: "SHILA", date: "2025-11-28", clockIn: "08:55", clockOut: "16:19", late: "", absent: "" },
            { name: "SHILA", date: "2025-11-29", clockIn: "09:18", clockOut: "19:30", late: "", absent: "" },
            { name: "ARNOB", date: "2025-11-01", clockIn: "09:51", clockOut: "19:24", late: "00:36", absent: "" },
            { name: "ARNOB", date: "2025-11-03", clockIn: "09:01", clockOut: "20:12", late: "", absent: "" },
            { name: "ARNOB", date: "2025-11-04", clockIn: "08:49", clockOut: "19:19", late: "", absent: "" },
            { name: "ARNOB", date: "2025-11-05", clockIn: "09:04", clockOut: "19:01", late: "", absent: "" },
            { name: "ARNOB", date: "2025-11-06", clockIn: "09:00", clockOut: "19:21", late: "", absent: "" },
            { name: "ARNOB", date: "2025-11-07", clockIn: "08:59", clockOut: "", late: "", absent: "" },
            { name: "ARNOB", date: "2025-11-10", clockIn: "09:02", clockOut: "20:24", late: "", absent: "" },
            { name: "ARNOB", date: "2025-11-11", clockIn: "08:49", clockOut: "20:13", late: "", absent: "" },
            { name: "ARNOB", date: "2025-11-12", clockIn: "09:00", clockOut: "20:07", late: "", absent: "" },
            { name: "ARNOB", date: "2025-11-13", clockIn: "08:51", clockOut: "19:29", late: "", absent: "" },
            { name: "ARNOB", date: "2025-11-14", clockIn: "08:45", clockOut: "20:54", late: "", absent: "" },
            { name: "ARNOB", date: "2025-11-15", clockIn: "08:25", clockOut: "17:47", late: "", absent: "" },
            { name: "ARNOB", date: "2025-11-17", clockIn: "08:46", clockOut: "20:12", late: "", absent: "" },
            { name: "ARNOB", date: "2025-11-18", clockIn: "08:56", clockOut: "19:14", late: "", absent: "" },
            { name: "ARNOB", date: "2025-11-19", clockIn: "09:02", clockOut: "19:23", late: "", absent: "" },
            { name: "ARNOB", date: "2025-11-20", clockIn: "09:14", clockOut: "19:00", late: "", absent: "" },
            { name: "ARNOB", date: "2025-11-21", clockIn: "09:06", clockOut: "19:00", late: "", absent: "" },
            { name: "ARNOB", date: "2025-11-22", clockIn: "09:20", clockOut: "18:58", late: "", absent: "" },
            { name: "ARNOB", date: "2025-11-24", clockIn: "08:53", clockOut: "21:37", late: "", absent: "" },
            { name: "ARNOB", date: "2025-11-25", clockIn: "08:49", clockOut: "20:04", late: "", absent: "" },
            { name: "ARNOB", date: "2025-11-26", clockIn: "08:47", clockOut: "22:43", late: "", absent: "" },
            { name: "ARNOB", date: "2025-11-27", clockIn: "08:39", clockOut: "19:03", late: "", absent: "" },
            { name: "ARNOB", date: "2025-11-28", clockIn: "10:35", clockOut: "19:11", late: "01:20", absent: "" },
            { name: "ARNOB", date: "2025-11-29", clockIn: "08:50", clockOut: "19:13", late: "", absent: "" },
            { name: "MAIDUL", date: "2025-11-01", clockIn: "09:25", clockOut: "", late: "00:10", absent: "" },
            { name: "MAIDUL", date: "2025-11-06", clockIn: "10:03", clockOut: "", late: "00:48", absent: "" },
            { name: "MAIDUL", date: "2025-11-29", clockIn: "09:14", clockOut: "", late: "", absent: "" },
            { name: "RAJU", date: "2025-11-01", clockIn: "09:03", clockOut: "19:08", late: "", absent: "" },
            { name: "RAJU", date: "2025-11-03", clockIn: "10:43", clockOut: "20:31", late: "01:28", absent: "" },
            { name: "RAJU", date: "2025-11-04", clockIn: "10:39", clockOut: "20:40", late: "01:24", absent: "" },
            { name: "RAJU", date: "2025-11-05", clockIn: "10:28", clockOut: "20:40", late: "01:13", absent: "" },
            { name: "RAJU", date: "2025-11-06", clockIn: "10:21", clockOut: "21:04", late: "01:06", absent: "" },
            { name: "RAJU", date: "2025-11-07", clockIn: "10:01", clockOut: "", late: "00:46", absent: "" },
            { name: "RAJU", date: "2025-11-10", clockIn: "10:36", clockOut: "21:12", late: "01:21", absent: "" },
            { name: "RAJU", date: "2025-11-11", clockIn: "10:32", clockOut: "20:33", late: "01:17", absent: "" },
            { name: "RAJU", date: "2025-11-12", clockIn: "10:20", clockOut: "20:18", late: "01:05", absent: "" },
            { name: "RAJU", date: "2025-11-13", clockIn: "08:51", clockOut: "19:52", late: "", absent: "" },
            { name: "RAJU", date: "2025-11-14", clockIn: "10:19", clockOut: "21:07", late: "01:04", absent: "" },
            { name: "RAJU", date: "2025-11-15", clockIn: "09:25", clockOut: "19:49", late: "00:10", absent: "" },
            { name: "RAJU", date: "2025-11-17", clockIn: "10:24", clockOut: "19:34", late: "01:09", absent: "" },
            { name: "RAJU", date: "2025-11-18", clockIn: "10:28", clockOut: "", late: "01:13", absent: "" },
            { name: "RAJU", date: "2025-11-20", clockIn: "10:25", clockOut: "", late: "01:10", absent: "" },
            { name: "RAJU", date: "2025-11-22", clockIn: "09:13", clockOut: "19:00", late: "", absent: "" },
            { name: "RAJU", date: "2025-11-24", clockIn: "10:26", clockOut: "20:43", late: "01:11", absent: "" },
            { name: "RAJU", date: "2025-11-25", clockIn: "10:42", clockOut: "", late: "01:27", absent: "" },
            { name: "RAJU", date: "2025-11-27", clockIn: "10:19", clockOut: "20:55", late: "01:04", absent: "" },
            { name: "RAJU", date: "2025-11-28", clockIn: "10:21", clockOut: "21:29", late: "01:06", absent: "" },
            { name: "RAJU", date: "2025-11-29", clockIn: "09:09", clockOut: "21:29", late: "", absent: "" },
            { name: "NAHID", date: "2025-11-01", clockIn: "08:58", clockOut: "", late: "", absent: "" },
            { name: "NAHID", date: "2025-11-15", clockIn: "08:50", clockOut: "", late: "", absent: "" },
            { name: "NAHID", date: "2025-11-29", clockIn: "08:54", clockOut: "", late: "", absent: "" },
            { name: "MIZAN", date: "2025-11-01", clockIn: "09:10", clockOut: "", late: "", absent: "" },
            { name: "MIZAN", date: "2025-11-15", clockIn: "09:05", clockOut: "", late: "", absent: "" },
            { name: "MIZAN", date: "2025-11-29", clockIn: "09:15", clockOut: "", late: "", absent: "" },
            { name: "BODIUZZAMAN", date: "2025-11-01", clockIn: "08:52", clockOut: "", late: "", absent: "" },
            { name: "BODIUZZAMAN", date: "2025-11-10", clockIn: "09:18", clockOut: "", late: "", absent: "" },
            { name: "BODIUZZAMAN", date: "2025-11-15", clockIn: "09:03", clockOut: "", late: "", absent: "" },
            { name: "BODIUZZAMAN", date: "2025-11-22", clockIn: "09:26", clockOut: "", late: "00:11", absent: "" },
            { name: "BODIUZZAMAN", date: "2025-11-26", clockIn: "09:12", clockOut: "", late: "", absent: "" },
            { name: "RIZVI", date: "2025-11-01", clockIn: "08:55", clockOut: "18:56", late: "", absent: "" },
            { name: "RIZVI", date: "2025-11-03", clockIn: "10:14", clockOut: "20:32", late: "00:59", absent: "" },
            { name: "RIZVI", date: "2025-11-05", clockIn: "11:08", clockOut: "20:22", late: "01:53", absent: "" },
            { name: "RIZVI", date: "2025-11-06", clockIn: "10:49", clockOut: "20:22", late: "01:34", absent: "" },
            { name: "RIZVI", date: "2025-11-07", clockIn: "10:24", clockOut: "20:28", late: "01:09", absent: "" },
            { name: "RIZVI", date: "2025-11-08", clockIn: "10:35", clockOut: "19:08", late: "01:20", absent: "" },
            { name: "RIZVI", date: "2025-11-10", clockIn: "10:12", clockOut: "20:34", late: "00:57", absent: "" },
            { name: "RIZVI", date: "2025-11-11", clockIn: "10:20", clockOut: "20:31", late: "01:05", absent: "" },
            { name: "RIZVI", date: "2025-11-14", clockIn: "10:01", clockOut: "19:12", late: "00:46", absent: "" },
            { name: "RIZVI", date: "2025-11-15", clockIn: "10:46", clockOut: "", late: "01:31", absent: "" },
            { name: "RIZVI", date: "2025-11-18", clockIn: "10:39", clockOut: "20:32", late: "01:24", absent: "" },
            { name: "RIZVI", date: "2025-11-19", clockIn: "10:22", clockOut: "20:36", late: "01:07", absent: "" },
            { name: "RIZVI", date: "2025-11-20", clockIn: "11:01", clockOut: "20:30", late: "01:46", absent: "" },
            { name: "RIZVI", date: "2025-11-21", clockIn: "10:43", clockOut: "", late: "01:28", absent: "" },
            { name: "RIZVI", date: "2025-11-24", clockIn: "12:26", clockOut: "20:53", late: "03:11", absent: "" },
            { name: "RIZVI", date: "2025-11-26", clockIn: "10:35", clockOut: "21:11", late: "01:20", absent: "" },
            { name: "RIZVI", date: "2025-11-27", clockIn: "10:28", clockOut: "21:19", late: "01:13", absent: "" },
            { name: "RIZVI", date: "2025-11-28", clockIn: "10:29", clockOut: "21:26", late: "01:14", absent: "" }
        ];
        
        // Alias for backward compatibility
        const excelAttendanceData = novemberAttendanceData;
        
        // Convert Excel attendance to app format
        let attendanceData = excelAttendanceData.map((att, index) => {
            // First shift employees: Ritu, Shila, Arnab, Badiul
            const firstShiftEmployees = ['Ritu', 'Shila', 'Arnob', 'Arnab', 'Badiul', 'Bodiuzzaman'];
            const isFirstShift = firstShiftEmployees.some(name => att.name.toLowerCase().includes(name.toLowerCase()));
            const shift = isFirstShift ? 'first' : 'second';
            
            // Determine if late based on shift (with 15-min grace period)
            // First Shift: Late if > 9:15 AM, Second Shift: Late if > 10:45 AM
            const isLate = att.late && att.late !== '';
            
            return {
                id: index + 1,
                employeeId: index + 1,
                employee: att.name,
                date: att.date,
                status: 'present',
                leaveType: null,
                clockInTime: att.clockIn,
                clockOutTime: att.clockOut,
                shift: shift,
                late: isLate,
                lateAmount: att.late,
                earlyLeave: false
            };
        });
        
        // Global attendance records for calculations (matching boss app format)
        let attendanceRecords = attendanceData.map(att => ({
            id: att.id,
            employeeId: att.employeeId,
            date: att.date,
            status: att.status,
            leaveType: att.leaveType,
            clockInTime: att.clockInTime,
            clockOutTime: att.clockOutTime,
            shift: att.shift,
            earlyLeave: att.earlyLeave
        }));
        
        // ============================================
        // LOGIC & UI FUNCTIONS
        // ============================================
        
        // Tab Switching Logic
        let attendanceSummaryChart = null;
        let earlyLeaveChart = null;
        let expenseByCategoryChart = null;

        async function showTab(tabId, element) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).classList.remove('hidden');
            if(element) element.classList.add('active');
            
            if(tabId === 'expenses') {
                loadExpensesTable();
                loadRejectionNotifications();
            }
            if(tabId === 'orders') loadOrdersTable();
            if(tabId === 'employees') loadEmployeesTable();
            if(tabId === 'attendance') loadAttendanceTable();
            if(tabId === 'salary') {
                loadSalaryData();
            }
            if(tabId === 'messages') {
                loadMessages();
            }
            if(tabId === 'reports') {
                await renderReportsDashboard();
            }
        }
        
        // Modal Logic
        function showModal(modalName) {
            document.getElementById(modalName + 'Modal').classList.add('active');
        }

        function hideModal(modalName) {
            document.getElementById(modalName + 'Modal').classList.remove('active');
        }

        // Loaders
        function loadExpensesTable() {
            const tbody = document.getElementById('expensesTableBody');
            tbody.innerHTML = '';
            
            // Get expenses from localStorage
            const storedExpenses = getExpensesFromStorage();
            
            // Combine with existing daily expenses
            const allExpenses = [...dailyExpenses, ...expenses, ...storedExpenses];
            
            // Sort by date (newest first)
            allExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            allExpenses.forEach(exp => {
                // Determine status badge styling
                let statusClass = 'status-approved';
                let statusText = exp.status || 'Approved';
                
                if (exp.status === 'Auto-Approved' || exp.status === 'Approved') {
                    statusClass = 'status-approved';
                } else if (exp.status === 'Pending') {
                    statusClass = 'status-pending';
                } else if (exp.status === 'Rejected') {
                    statusClass = 'status-rejected';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${exp.date}</td>
                    <td>${exp.description}</td>
                    <td>${exp.category || exp.type}</td>
                    <td style="font-weight: 600; color: var(--color-warning);">৳${exp.amount.toLocaleString()}</td>
                    <td>
                        <span 
                            class="status-badge ${statusClass}" 
                            ${exp.rejectionReason ? `title="Reason: ${exp.rejectionReason}" style="cursor: help;"` : ''}>
                            ${statusText}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            calculatePettyCash();
        }
        
        function calculatePettyCash() {
            const totalExpenses = dailyExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const totalReceived = 150000; // Mock initial received amount
            
            document.getElementById('pettyCashReceived').textContent = `৳${totalReceived.toLocaleString()}`;
            document.getElementById('pettyCashExpenses').textContent = `৳${totalExpenses.toLocaleString()}`;
            document.getElementById('pettyCashBalance').textContent = `৳${(totalReceived - totalExpenses).toLocaleString()}`;
        }

        // --------------------------------------------
        // REPORTS & ANALYTICS HELPERS
        // --------------------------------------------

        function getCurrentMonthInfo() {
            // Get the latest month from actual attendance data
            const storedAttendance = getAttendanceFromStorage();
            
            if (storedAttendance.length > 0) {
                // Find the latest date in the data
                const dates = storedAttendance.map(r => new Date(r.date)).filter(d => !isNaN(d.getTime()));
                if (dates.length > 0) {
                    const latestDate = new Date(Math.max(...dates));
                    const year = latestDate.getFullYear();
                    const monthIndex = latestDate.getMonth();
                    const monthLabel = latestDate.toLocaleString('en-US', { month: 'long', year: 'numeric' });
                    return { year, monthIndex, monthLabel };
                }
            }
            
            // Fallback to current month if no data
            const now = new Date();
            const year = now.getFullYear();
            const monthIndex = now.getMonth();
            const monthLabel = now.toLocaleString('en-US', { month: 'long', year: 'numeric' });
            return { year, monthIndex, monthLabel };
        }

        function isInMonth(dateStr, year, monthIndex) {
            if (!dateStr) return false;
            const d = new Date(dateStr);
            if (isNaN(d.getTime())) return false;
            return d.getFullYear() === year && d.getMonth() === monthIndex;
        }

        function isInCurrentMonth(dateStr) {
            if (!dateStr) return false;
            const d = new Date(dateStr);
            if (isNaN(d.getTime())) return false;
            const { year, monthIndex } = getCurrentMonthInfo();
            return d.getFullYear() === year && d.getMonth() === monthIndex;
        }

        async function buildAttendanceAnalyticsForCurrentMonth() {
            const { year, monthIndex, monthLabel } = getCurrentMonthInfo();
            
            // Get attendance from Supabase or fallback to localStorage
            let storedAttendance = [];
            if (supabaseAvailable) {
                storedAttendance = await getAttendanceFromSupabase(monthIndex + 1, year);
                // Convert Supabase format to expected format
                storedAttendance = storedAttendance.map(r => ({
                    name: r.employee_name,
                    date: r.date,
                    clockIn: r.clock_in,
                    clockOut: r.clock_out,
                    late: r.late_time,
                    absent: r.absent_type,
                    status: r.status,
                    isLate: r.is_late,
                    isEarlyLeave: r.is_early_leave
                }));
            } else {
                storedAttendance = getAttendanceFromStorage();
            }
            
            // Filter records for the current/latest month (if not already filtered)
            const monthRecords = storedAttendance.filter(r => isInMonth(r.date, year, monthIndex));
            
            let presentDays = 0;
            let lateDays = 0;
            let earlyLeaveDays = 0;
            let ulDays = 0;
            let alDays = 0;
            const earlyLeavePerEmployee = {};
            const latePerEmployee = {};
            const uniqueEmployees = new Set();

            monthRecords.forEach(r => {
                const name = r.name || 'Unknown';
                uniqueEmployees.add(name);

                // Status-based counting
                if (r.status === 'Absent') {
                    if (r.absent && r.absent.toUpperCase() === 'UL') {
                        ulDays += 1;
                    } else {
                        alDays += 1;
                    }
                } else {
                    // Present or Late counts as a worked day
                    presentDays += 1;
                    
                    // Check if late (has late time recorded)
                    const isActuallyLate = r.isLate || (r.late && r.late !== '');
                    if (isActuallyLate) {
                        lateDays += 1;
                        latePerEmployee[name] = (latePerEmployee[name] || 0) + 1;
                    }
                }

                // Check for early leave
                const leftEarly = r.isEarlyLeave;
                if (leftEarly) {
                    earlyLeaveDays += 1;
                    earlyLeavePerEmployee[name] = (earlyLeavePerEmployee[name] || 0) + 1;
                }
            });

            return {
                monthLabel,
                presentDays,
                lateDays,
                earlyLeaveDays,
                ulDays,
                alDays,
                totalAttendanceDays: monthRecords.length,
                uniqueEmployeeCount: uniqueEmployees.size,
                earlyLeavePerEmployee,
                latePerEmployee
            };
        }

        async function buildExpenseAnalyticsForCurrentMonth() {
            const { year, monthIndex, monthLabel } = getCurrentMonthInfo();
            
            // Get expenses from Supabase or fallback to localStorage
            let storedExpenses = [];
            if (supabaseAvailable) {
                const startDate = `${year}-${String(monthIndex + 1).padStart(2, '0')}-01`;
                const endDate = `${year}-${String(monthIndex + 1).padStart(2, '0')}-31`;
                storedExpenses = await getExpensesFromSupabase({ startDate, endDate });
                // Convert Supabase format
                storedExpenses = storedExpenses.map(e => ({
                    id: e.id,
                    employee: e.employee_name,
                    description: e.description,
                    amount: parseFloat(e.amount),
                    category: e.category,
                    date: e.date,
                    status: e.status
                }));
            } else {
                storedExpenses = getExpensesFromStorage();
            }
            
            const allExpenses = [...dailyExpenses, ...expenses, ...storedExpenses];

            // Filter by the same month as attendance data
            const monthExpenses = allExpenses.filter(exp => {
                if (!exp.date) return false;
                const d = new Date(exp.date);
                if (isNaN(d.getTime())) return false;
                return d.getFullYear() === year && d.getMonth() === monthIndex;
            });

            const byCategory = {};
            let totalAmount = 0;
            let highValueCount = 0;
            let lowValueCount = 0;
            let approvedCount = 0;
            let pendingCount = 0;

            monthExpenses.forEach(exp => {
                const category = exp.category || exp.type || 'Others';
                byCategory[category] = (byCategory[category] || 0) + exp.amount;
                totalAmount += exp.amount;
                if (exp.amount >= 5000) {
                    highValueCount += 1;
                } else {
                    lowValueCount += 1;
                }
                if (exp.status === 'Approved' || exp.status === 'Auto-Approved') {
                    approvedCount += 1;
                } else if (exp.status === 'Pending') {
                    pendingCount += 1;
                }
            });

            return {
                monthLabel,
                byCategory,
                totalAmount,
                highValueCount,
                lowValueCount,
                approvedCount,
                pendingCount,
                totalCount: monthExpenses.length,
                hasData: monthExpenses.length > 0
            };
        }

        async function renderReportsDashboard() {
            const monthInfo = getCurrentMonthInfo();
            const attendanceAnalytics = await buildAttendanceAnalyticsForCurrentMonth();
            const expenseAnalytics = await buildExpenseAnalyticsForCurrentMonth();

            const monthLabelEl = document.getElementById('reportsMonthLabel');
            if (monthLabelEl) {
                monthLabelEl.textContent = `${attendanceAnalytics.monthLabel} overview based on real attendance & expenses`;
            }

            // Update top metrics
            const totalAttendanceEl = document.getElementById('metricTotalAttendance');
            const totalLateEl = document.getElementById('metricTotalLate');
            const totalEarlyLeaveEl = document.getElementById('metricTotalEarlyLeave');
            const totalULEl = document.getElementById('metricTotalUL');

            if (totalAttendanceEl) totalAttendanceEl.textContent = attendanceAnalytics.totalAttendanceDays || 0;
            if (totalLateEl) totalLateEl.textContent = attendanceAnalytics.lateDays || 0;
            if (totalEarlyLeaveEl) totalEarlyLeaveEl.textContent = attendanceAnalytics.earlyLeaveDays || 0;
            if (totalULEl) totalULEl.textContent = attendanceAnalytics.ulDays || 0;

            // Attendance discipline chart
            const attendanceEmpty = document.getElementById('attendanceEmptyState');
            const attendanceCanvas = document.getElementById('attendanceSummaryChart');
            const attendanceSubtitle = document.getElementById('attendanceChartSubtitle');

            if (attendanceSubtitle) {
                attendanceSubtitle.textContent = `(${attendanceAnalytics.totalAttendanceDays || 0} records)`;
            }

            if (!attendanceCanvas) return;

            if (attendanceAnalytics.totalAttendanceDays === 0) {
                if (attendanceEmpty) attendanceEmpty.style.display = 'block';
                attendanceCanvas.style.display = 'none';
            } else {
                if (attendanceEmpty) attendanceEmpty.style.display = 'none';
                attendanceCanvas.style.display = 'block';
            }

            const ctxAttendance = attendanceCanvas.getContext('2d');
            if (attendanceSummaryChart) {
                attendanceSummaryChart.destroy();
            }

            if (attendanceAnalytics.totalAttendanceDays > 0) {
                attendanceSummaryChart = new Chart(ctxAttendance, {
                    type: 'bar',
                    data: {
                        labels: ['Present / Late', 'Late', 'Early Leave', 'AL', 'UL'],
                        datasets: [{
                            label: 'Days',
                            data: [
                                attendanceAnalytics.presentDays,
                                attendanceAnalytics.lateDays,
                                attendanceAnalytics.earlyLeaveDays,
                                attendanceAnalytics.alDays,
                                attendanceAnalytics.ulDays
                            ],
                            backgroundColor: [
                                'rgba(16, 185, 129, 0.65)',
                                'rgba(245, 158, 11, 0.75)',
                                'rgba(248, 250, 252, 0.8)',
                                'rgba(59, 130, 246, 0.65)',
                                'rgba(239, 68, 68, 0.85)'
                            ],
                            borderRadius: 10,
                            maxBarThickness: 40
                        }]
                    },
                    options: {
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.9)',
                                borderColor: 'rgba(0, 0, 0, 0.2)',
                                borderWidth: 1,
                                padding: 10,
                                titleFont: { size: 12, family: 'Inter' },
                                bodyFont: { size: 12, family: 'Inter' }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: '#666',
                                    font: { size: 11 }
                                },
                                grid: { display: false }
                            },
                            y: {
                                ticks: {
                                    color: '#666',
                                    stepSize: 1,
                                    precision: 0
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)',
                                    drawBorder: false
                                }
                            }
                        }
                    }
                });
            }

            // Late arrivals by employee chart (using latePerEmployee data)
            const earlyLeaveEmpty = document.getElementById('earlyLeaveEmptyState');
            const earlyLeaveCanvas = document.getElementById('earlyLeaveChart');
            const earlyLeaveSubtitle = document.getElementById('earlyLeaveChartSubtitle');

            // Use late per employee data (more relevant)
            const lateNames = Object.keys(attendanceAnalytics.latePerEmployee || {});
            const lateValues = lateNames.map(name => attendanceAnalytics.latePerEmployee[name]);
            
            // Sort by late count descending and take top 10
            const sortedLate = lateNames.map((name, i) => ({ name, count: lateValues[i] }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);
            
            const displayNames = sortedLate.map(x => x.name);
            const displayValues = sortedLate.map(x => x.count);

            if (earlyLeaveSubtitle) {
                earlyLeaveSubtitle.textContent = displayNames.length > 0 ? `(${lateNames.length} employees with late arrivals)` : '';
            }

            if (displayNames.length === 0) {
                if (earlyLeaveEmpty) earlyLeaveEmpty.style.display = 'block';
                if (earlyLeaveCanvas) earlyLeaveCanvas.style.display = 'none';
            } else {
                if (earlyLeaveEmpty) earlyLeaveEmpty.style.display = 'none';
                if (earlyLeaveCanvas) earlyLeaveCanvas.style.display = 'block';
            }

            if (earlyLeaveCanvas) {
                const ctxEarly = earlyLeaveCanvas.getContext('2d');
                if (earlyLeaveChart) {
                    earlyLeaveChart.destroy();
                }

                if (displayNames.length > 0) {
                    earlyLeaveChart = new Chart(ctxEarly, {
                        type: 'bar',
                        data: {
                            labels: displayNames,
                            datasets: [{
                                label: 'Late Arrivals',
                                data: displayValues,
                                backgroundColor: 'rgba(245, 158, 11, 0.85)',
                                borderRadius: 10,
                                maxBarThickness: 40
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                x: {
                                    ticks: {
                                        color: '#666',
                                        stepSize: 1,
                                        precision: 0
                                    },
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.1)',
                                        drawBorder: false
                                    }
                                },
                                y: {
                                    ticks: {
                                        color: '#666'
                                    },
                                    grid: { display: false }
                                }
                            }
                        }
                    });
                }
            }

            // Expenses by category chart
            const expensesEmpty = document.getElementById('expensesEmptyState');
            const expenseCanvas = document.getElementById('expenseByCategoryChart');
            const expenseSubtitle = document.getElementById('expenseChartSubtitle');

            const categoryNames = Object.keys(expenseAnalytics.byCategory || {});
            const categoryValues = categoryNames.map(name => expenseAnalytics.byCategory[name]);

            if (expenseSubtitle) {
                expenseSubtitle.textContent = expenseAnalytics.hasData ? `(${expenseAnalytics.monthLabel})` : '';
            }

            if (!expenseCanvas) return;

            if (!expenseAnalytics.hasData) {
                if (expensesEmpty) expensesEmpty.style.display = 'block';
                expenseCanvas.style.display = 'none';
            } else {
                if (expensesEmpty) expensesEmpty.style.display = 'none';
                expenseCanvas.style.display = 'block';
            }

            const totalExpenseEl = document.getElementById('metricTotalExpense');
            const highValueEl = document.getElementById('metricHighValueCount');
            const lowValueEl = document.getElementById('metricLowValueCount');

            if (totalExpenseEl) {
                totalExpenseEl.textContent = `৳${Math.round(expenseAnalytics.totalAmount).toLocaleString()}`;
            }
            if (highValueEl) highValueEl.textContent = expenseAnalytics.highValueCount || 0;
            if (lowValueEl) lowValueEl.textContent = expenseAnalytics.lowValueCount || 0;

            const ctxExpense = expenseCanvas.getContext('2d');
            if (expenseByCategoryChart) {
                expenseByCategoryChart.destroy();
            }

            if (expenseAnalytics.hasData) {
                const palette = [
                    'rgba(0, 0, 0, 0.7)',
                    'rgba(59, 130, 246, 0.9)',
                    'rgba(34, 197, 94, 0.9)',
                    'rgba(244, 114, 182, 0.9)',
                    'rgba(248, 113, 113, 0.9)',
                    'rgba(96, 165, 250, 0.9)'
                ];

                expenseByCategoryChart = new Chart(ctxExpense, {
                    type: 'doughnut',
                    data: {
                        labels: categoryNames,
                        datasets: [{
                            data: categoryValues,
                            backgroundColor: categoryNames.map((_, idx) => palette[idx % palette.length]),
                            borderWidth: 1,
                            borderColor: '#fff',
                            hoverOffset: 6
                        }]
                    },
                    options: {
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    color: '#000',
                                    font: { size: 11 }
                                }
                            }
                        },
                        cutout: '65%'
                    }
                });
            }
        }
        
        // Load and display rejection notifications
        function loadRejectionNotifications() {
            const notifications = getRejectionNotifications(); // Get unread only
            const notificationsList = document.getElementById('rejectionNotificationsList');
            const notificationBadge = document.getElementById('notificationBadge');
            const noNotifications = document.getElementById('noNotifications');
            
            // Update badge count
            if (notifications.length > 0) {
                notificationBadge.textContent = notifications.length;
                notificationBadge.style.display = 'inline-block';
            } else {
                notificationBadge.style.display = 'none';
            }
            
            // Clear list
            notificationsList.innerHTML = '';
            
            if (notifications.length === 0) {
                // Show empty state
                notificationsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--color-text-muted);">
                        <i data-lucide="check-circle" style="width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.3;"></i>
                        <p>No rejection notifications</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            // Display notifications
            notifications.forEach(notification => {
                const notifDiv = document.createElement('div');
                notifDiv.style.cssText = `
                    background: rgba(239, 68, 68, 0.1);
                    border: 1px solid rgba(239, 68, 68, 0.2);
                    border-radius: 16px;
                    padding: 20px;
                    margin-bottom: 16px;
                `;
                
                const notifDate = new Date(notification.date);
                const formattedDate = notifDate.toLocaleString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    hour: 'numeric', 
                    minute: '2-digit' 
                });
                
                notifDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <div>
                            <div style="font-weight: 600; color: var(--color-danger); font-size: 16px; margin-bottom: 4px;">
                                <i data-lucide="x-circle" style="width: 16px; height: 16px;"></i> Expense Rejected
                            </div>
                            <div style="font-size: 13px; color: var(--color-text-muted);">${formattedDate}</div>
                        </div>
                        <button 
                            class="btn btn-sm btn-secondary" 
                            onclick="markNotificationAsRead(${notification.id})"
                            style="padding: 6px 12px;">
                            Mark as Read
                        </button>
                    </div>
                    <div style="font-size: 14px; color: #000; margin-bottom: 8px;">
                        <strong>Expense:</strong> ${notification.expenseDescription}
                    </div>
                    <div style="padding: 12px; background: rgba(0,0,0,0.03); border-radius: 8px; border-left: 3px solid var(--color-danger);">
                        <div style="font-size: 12px; color: var(--color-text-muted); margin-bottom: 4px;">Rejection Reason:</div>
                        <div style="font-size: 14px; color: #000;">${notification.rejectionReason}</div>
                    </div>
                `;
                
                notificationsList.appendChild(notifDiv);
            });
            
            lucide.createIcons();
        }
        
        // Mark notification as read
        function markNotificationAsRead(notificationId) {
            markRejectionNotificationRead(notificationId);
            loadRejectionNotifications();
            showNotification('Notification marked as read');
        }

        function loadOrdersTable() {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = '';
            
            const orders = getOrdersFromStorage();
            
            // Update summary stats
            const totalOrders = orders.length;
            const pendingOrders = orders.filter(o => o.status === 'Pending').length;
            let totalCommission = 0;
            
            orders.forEach(order => {
                const commission = calculateOrderCommission(order);
                totalCommission += commission.netCommission;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 600; color: #000;">${order.orderNumber}</td>
                    <td>${order.clientName}</td>
                    <td>${order.factoryName}</td>
                    <td style="font-family: monospace;">$${order.fobValue.toLocaleString()}</td>
                    <td style="font-family: monospace;">$${order.factoryCost.toLocaleString()}</td>
                    <td style="font-weight: 600; color: var(--color-success); font-family: monospace;">$${commission.netCommission.toLocaleString()}</td>
                    <td>${order.shipmentDate}</td>
                    <td><span class="status-badge ${order.status === 'Cleared' ? 'status-approved' : 'status-pending'}">${order.status}</span></td>
                    <td>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-sm btn-secondary" onclick="toggleOrderStatus(${order.id})" title="Toggle Status">
                                <i data-lucide="${order.status === 'Cleared' ? 'clock' : 'check'}" style="width: 14px;"></i>
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="deleteOrder(${order.id})" title="Delete" style="color: var(--color-danger);">
                                <i data-lucide="trash-2" style="width: 14px;"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Update summary cards
            document.getElementById('totalOrdersCount').textContent = totalOrders;
            document.getElementById('totalCommission').textContent = `$${Math.round(totalCommission).toLocaleString()}`;
            document.getElementById('pendingShipments').textContent = pendingOrders;
            
            lucide.createIcons();
        }
        
        // Toggle order status
        function toggleOrderStatus(orderId) {
            const orders = getOrdersFromStorage();
            const order = orders.find(o => o.id === orderId);
            if (order) {
                order.status = order.status === 'Cleared' ? 'Pending' : 'Cleared';
                updateOrderInStorage(order);
                loadOrdersTable();
                showNotification(`Order ${order.orderNumber} marked as ${order.status}`);
            }
        }
        
        // Delete order
        function deleteOrder(orderId) {
            if (confirm('Are you sure you want to delete this order?')) {
                deleteOrderFromStorage(orderId);
                loadOrdersTable();
                showNotification('Order deleted');
            }
        }
        
        // Load and display messages
        function loadMessages() {
            const messagesList = document.getElementById('messagesList');
            const messages = getMessages();
            
            // Filter messages for employee (sent by boss)
            const employeeMessages = messages.filter(m => m.to === 'employee').sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            if (employeeMessages.length === 0) {
                messagesList.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: var(--color-text-muted);">
                        <i data-lucide="inbox" style="width: 64px; height: 64px; margin-bottom: 16px; opacity: 0.2;"></i>
                        <h3 style="font-size: 18px; margin-bottom: 8px;">No Messages Yet</h3>
                        <p style="font-size: 14px;">Boss hasn't sent any messages yet</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            messagesList.innerHTML = '';
            
            employeeMessages.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.style.cssText = `
                    background: ${message.read ? 'rgba(0,0,0,0.02)' : 'rgba(0, 0, 0, 0.05)'};
                    border: ${message.read ? 'var(--glass-border)' : '1px solid rgba(0, 0, 0, 0.15)'};
                    border-radius: 16px;
                    padding: 24px;
                    margin-bottom: 16px;
                    position: relative;
                `;
                
                const messageDate = new Date(message.timestamp);
                const formattedDate = messageDate.toLocaleString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: true
                });
                
                // Get replies for this message
                const replies = messages.filter(m => m.replyTo === message.id);
                
                messageDiv.innerHTML = `
                    ${!message.read ? '<div style="position: absolute; top: 16px; right: 16px; background: var(--color-warning); color: #000; font-size: 10px; font-weight: 700; padding: 4px 8px; border-radius: 12px;">NEW</div>' : ''}
                    
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--color-primary); display: flex; align-items: center; justify-content: center; color: #000; font-weight: 700; font-size: 16px;">
                            B
                        </div>
                        <div>
                            <div style="font-weight: 600; color: #000; font-size: 15px;">Boss</div>
                            <div style="font-size: 12px; color: var(--color-text-muted);">${formattedDate}</div>
                        </div>
                    </div>
                    
                    <div style="font-size: 15px; color: #333; line-height: 1.6; margin-bottom: 16px; padding-left: 52px;">
                        ${message.content}
                    </div>
                    
                    <!-- Replies Section -->
                    ${replies.length > 0 ? `
                        <div style="margin-left: 52px; padding-left: 20px; border-left: 2px solid rgba(0, 0, 0, 0.15); margin-bottom: 16px;">
                            ${replies.map(reply => `
                                <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 12px; padding: 12px; margin-bottom: 8px;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <div style="width: 24px; height: 24px; border-radius: 50%; background: var(--color-success); display: flex; align-items: center; justify-content: center; color: #000; font-weight: 700; font-size: 11px;">
                                            R
                                        </div>
                                        <div style="font-size: 12px; color: var(--color-text-muted);">
                                            ${new Date(reply.timestamp).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true })}
                                        </div>
                                    </div>
                                    <div style="font-size: 14px; color: #333; padding-left: 32px;">
                                        ${reply.content}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <!-- Reply Form -->
                    <div id="replyForm${message.id}" style="margin-left: 52px; display: ${message.showReply ? 'block' : 'none'};">
                        <textarea 
                            id="replyText${message.id}" 
                            placeholder="Type your reply..." 
                            style="width: 100%; min-height: 80px; padding: 12px; background: rgba(0,0,0,0.03); border: var(--glass-border); border-radius: 12px; color: #000; font-family: var(--font-sans); font-size: 14px; resize: vertical; margin-bottom: 12px; outline: none;"
                        ></textarea>
                        <div style="display: flex; gap: 12px;">
                            <button onclick="cancelReply(${message.id})" class="btn btn-secondary btn-sm">Cancel</button>
                            <button onclick="sendReply(${message.id})" class="btn btn-primary btn-sm">
                                <i data-lucide="send" style="width: 14px;"></i> Send Reply
                            </button>
                        </div>
                    </div>
                    
                    <div style="padding-left: 52px;">
                        <button onclick="showReplyForm(${message.id})" id="replyBtn${message.id}" class="btn btn-secondary btn-sm" style="${message.showReply ? 'display: none;' : ''}">
                            <i data-lucide="reply" style="width: 14px;"></i> Reply
                        </button>
                    </div>
                `;
                
                messagesList.appendChild(messageDiv);
                
                // Mark as read when displayed
                if (!message.read) {
                    markMessageAsRead(message.id);
                }
            });
            
            lucide.createIcons();
            updateMessageBadge();
        }
        
        // Show reply form
        function showReplyForm(messageId) {
            document.getElementById(`replyForm${messageId}`).style.display = 'block';
            document.getElementById(`replyBtn${messageId}`).style.display = 'none';
            document.getElementById(`replyText${messageId}`).focus();
        }
        
        // Cancel reply
        function cancelReply(messageId) {
            document.getElementById(`replyForm${messageId}`).style.display = 'none';
            document.getElementById(`replyBtn${messageId}`).style.display = 'inline-flex';
            document.getElementById(`replyText${messageId}`).value = '';
        }
        
        // Send reply
        function sendReply(messageId) {
            const replyText = document.getElementById(`replyText${messageId}`).value.trim();
            
            if (!replyText) {
                showNotification('Please type a reply');
                return;
            }
            
            const reply = {
                id: Date.now(),
                from: 'employee',
                to: 'boss',
                content: replyText,
                replyTo: messageId,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            saveMessage(reply);
            showNotification('✓ Reply sent to Boss');
            loadMessages();
        }
        
        // Refresh messages
        function refreshMessages() {
            loadMessages();
            showNotification('Messages refreshed');
        }
        
        // Update message badge count
        function updateMessageBadge() {
            const badge = document.getElementById('messagesBadge');
            const unreadCount = getUnreadMessageCount();
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }

        function loadEmployeesTable() {
            const tbody = document.getElementById('employeesTableBody');
            tbody.innerHTML = '';
            
            // Refresh employees from localStorage
            employees = getEmployeesFromStorage();
            
            // Show active employees first, then left employees
            const sortedEmployees = [...employees].sort((a, b) => {
                if (a.status === 'active' && b.status !== 'active') return -1;
                if (a.status !== 'active' && b.status === 'active') return 1;
                return a.name.localeCompare(b.name);
            });
            
            sortedEmployees.forEach((emp, index) => {
                const shift = emp.shift || getEmployeeShift(emp.name);
                const shiftText = shift === 1 ? '1st Shift (9AM-7PM)' : '2nd Shift (10:30AM-8:30PM)';
                const isLeft = emp.status === 'left';
                
                // Status badge
                let statusBadge = '';
                if (isLeft) {
                    const leftDate = emp.leftDate ? new Date(emp.leftDate).toLocaleDateString('en-US', { month: 'short', year: 'numeric' }) : '';
                    statusBadge = `<span class="status-badge status-rejected">Left${leftDate ? ` (${leftDate})` : ''}</span>`;
                } else {
                    statusBadge = `<span class="status-badge status-approved">Active</span>`;
                }
                
                // Action buttons - simplified: only Remove/Reinstate and Delete
                let actionButtons = '';
                if (isLeft) {
                    actionButtons = `
                        <button class="btn btn-sm" style="background: rgba(16, 185, 129, 0.2); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.3);" onclick="confirmReinstateEmployee(${emp.id})" title="Reinstate Employee">
                            <i data-lucide="user-check" style="width: 14px;"></i>
                        </button>
                        <button class="btn btn-sm" style="background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3);" onclick="confirmDeleteEmployee(${emp.id}, '${emp.name}')" title="Delete Permanently">
                            <i data-lucide="trash-2" style="width: 14px;"></i>
                        </button>
                    `;
                } else {
                    actionButtons = `
                        <button class="btn btn-sm" style="background: rgba(0, 0, 0, 0.1); color: #000; border: 1px solid rgba(0, 0, 0, 0.15);" onclick="confirmRemoveEmployee(${emp.id}, '${emp.name}')" title="Mark as Left">
                            <i data-lucide="user-minus" style="width: 14px;"></i>
                        </button>
                        <button class="btn btn-sm" style="background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3);" onclick="confirmDeleteEmployee(${emp.id}, '${emp.name}')" title="Delete Permanently">
                            <i data-lucide="trash-2" style="width: 14px;"></i>
                        </button>
                    `;
                }
                
                const row = document.createElement('tr');
                row.style.opacity = isLeft ? '0.6' : '1';
                row.innerHTML = `
                    <td style="color: var(--color-text-muted);">${index + 1}</td>
                    <td style="font-weight: 600; color: ${isLeft ? 'var(--color-text-muted)' : '#000'};">${emp.name}</td>
                    <td>${emp.role || 'N/A'}</td>
                    <td>${emp.department || 'N/A'}</td>
                    <td style="font-size: 12px; color: var(--color-text-muted);">${shiftText}</td>
                    <td>${statusBadge}</td>
                    <td style="display: flex; gap: 6px;">
                        ${actionButtons}
                    </td>
                `;
                tbody.appendChild(row);
            });
            lucide.createIcons();
        }
        
        // Confirm and remove employee
        function confirmRemoveEmployee(employeeId, employeeName) {
            const reason = prompt(`Why is ${employeeName} leaving?\n\nOptions: Resigned, Terminated, Contract Ended, Other\n\nEnter reason:`);
            if (reason !== null) {
                const finalReason = reason.trim() || 'Resigned';
                if (confirm(`Are you sure you want to mark ${employeeName} as LEFT?\n\nReason: ${finalReason}\n\nTheir historical data will be preserved.`)) {
                    removeEmployee(employeeId, finalReason);
                    loadEmployeesTable();
                    showNotification(`${employeeName} has been marked as left`);
                }
            }
        }
        
        // Confirm and reinstate employee
        function confirmReinstateEmployee(employeeId) {
            const emp = getEmployeesFromStorage().find(e => e.id === employeeId);
            if (emp && confirm(`Reinstate ${emp.name} as an active employee?`)) {
                reinstateEmployee(employeeId);
                loadEmployeesTable();
                showNotification(`${emp.name} has been reinstated`);
            }
        }
        
        // Confirm and permanently delete employee
        function confirmDeleteEmployee(employeeId, employeeName) {
            if (confirm(`⚠️ PERMANENTLY DELETE ${employeeName}?\n\nThis will remove ALL their data including historical records.\n\nThis action CANNOT be undone!`)) {
                if (confirm(`Final confirmation: Delete ${employeeName} forever?`)) {
                    deleteEmployeePermanently(employeeId);
                    loadEmployeesTable();
                    showNotification(`${employeeName} has been permanently deleted`, 'warning');
                }
            }
        }
        
        // ============================================
        // SALARY MANAGEMENT FUNCTIONS
        // ============================================
        
        // Get salary records from localStorage
        function getSalaryRecordsFromStorage() {
            const stored = localStorage.getItem('indigoSalaryRecords');
            return stored ? JSON.parse(stored) : {};
        }
        
        // Save salary records to localStorage
        function saveSalaryRecordsToStorage(records) {
            localStorage.setItem('indigoSalaryRecords', JSON.stringify(records));
        }
        
        // Setup salary drop zone
        function setupSalaryDropZone() {
            const dropZone = document.getElementById('salaryDropZone');
            const fileInput = document.getElementById('salaryFileInput');
            
            if (!dropZone || !fileInput) return;
            
            // Click to browse
            dropZone.addEventListener('click', () => fileInput.click());
            
            // File input change
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleSalaryExcelFile(e.target.files[0]);
                }
            });
            
            // Drag events
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-over');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleSalaryExcelFile(files[0]);
                }
            });
        }
        
        // Handle salary Excel file upload
        function handleSalaryExcelFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/i)) {
                showNotification('Please upload an Excel file (.xlsx or .xls)', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // Parse the salary data
                    const parsedData = parseSalaryExcel(firstSheet, workbook);
                    
                    if (parsedData && parsedData.records.length > 0) {
                        // Save to localStorage with month key
                        const salaryRecords = getSalaryRecordsFromStorage();
                        salaryRecords[parsedData.monthKey] = {
                            monthLabel: parsedData.monthLabel,
                            uploadedAt: new Date().toISOString(),
                            records: parsedData.records
                        };
                        saveSalaryRecordsToStorage(salaryRecords);
                        
                        // Update month selector and display
                        updateSalaryMonthSelector();
                        document.getElementById('salaryMonth').value = parsedData.monthKey;
                        loadSalaryData();
                        
                        showNotification(`Salary data for ${parsedData.monthLabel} uploaded successfully (${parsedData.records.length} employees)`);
                    } else {
                        showNotification('Could not parse salary data from file', 'error');
                    }
                } catch (error) {
                    console.error('Error parsing salary Excel:', error);
                    showNotification('Error reading Excel file: ' + error.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        // Parse salary Excel sheet
        function parseSalaryExcel(sheet, workbook) {
            // Convert to JSON with header detection
            const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            
            // Find the header row (contains "Name", "Gross Salary", etc.)
            let headerRowIndex = -1;
            let headers = [];
            
            for (let i = 0; i < Math.min(10, jsonData.length); i++) {
                const row = jsonData[i];
                if (row && row.some(cell => String(cell).toLowerCase().includes('name')) && 
                    row.some(cell => String(cell).toLowerCase().includes('gross'))) {
                    headerRowIndex = i;
                    headers = row.map(h => String(h || '').trim());
                    break;
                }
            }
            
            if (headerRowIndex === -1) {
                console.error('Could not find header row');
                return null;
            }
            
            // Find date in the sheet (usually in first few rows)
            let monthKey = new Date().toISOString().slice(0, 7);
            let monthLabel = 'Unknown Month';
            
            for (let i = 0; i < headerRowIndex; i++) {
                const row = jsonData[i];
                for (let cell of row) {
                    if (cell) {
                        const cellStr = String(cell);
                        // Check for date format
                        if (cellStr.match(/\d{4}-\d{2}-\d{2}/) || cellStr.match(/\d{1,2}[-\/]\d{1,2}[-\/]\d{2,4}/)) {
                            const date = new Date(cell);
                            if (!isNaN(date.getTime())) {
                                monthKey = date.toISOString().slice(0, 7);
                                monthLabel = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                            }
                        }
                        // Check for month name
                        const months = ['january', 'february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december'];
                        const lowerCell = cellStr.toLowerCase();
                        for (let m = 0; m < months.length; m++) {
                            if (lowerCell.includes(months[m])) {
                                const yearMatch = cellStr.match(/20\d{2}/);
                                const year = yearMatch ? yearMatch[0] : new Date().getFullYear();
                                monthKey = `${year}-${String(m + 1).padStart(2, '0')}`;
                                monthLabel = `${months[m].charAt(0).toUpperCase() + months[m].slice(1)} ${year}`;
                                break;
                            }
                        }
                    }
                }
            }
            
            // Map column indices
            const colMap = {
                sl: headers.findIndex(h => h.toLowerCase().includes('sl')),
                name: headers.findIndex(h => h.toLowerCase().includes('name')),
                designation: headers.findIndex(h => h.toLowerCase().includes('designation') || h.toLowerCase().includes('role')),
                grossSalary: headers.findIndex(h => h.toLowerCase().includes('gross')),
                taxDeduction: headers.findIndex(h => h.toLowerCase().includes('tax') || h.toLowerCase().includes('deduction')),
                payCash: headers.findIndex(h => h.toLowerCase().includes('cash')),
                payBank: headers.findIndex(h => h.toLowerCase().includes('bank') && !h.toLowerCase().includes('account')),
                netPay: headers.findIndex(h => h.toLowerCase().includes('net')),
                bankAccount: headers.findIndex(h => h.toLowerCase().includes('account')),
                branch: headers.findIndex(h => h.toLowerCase().includes('branch')),
                remarks: headers.findIndex(h => h.toLowerCase().includes('remark'))
            };
            
            // Parse data rows
            const records = [];
            for (let i = headerRowIndex + 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row || !row[colMap.name]) continue;
                
                const name = String(row[colMap.name] || '').trim();
                if (!name || name.toLowerCase() === 'total' || name.toLowerCase().includes('grand')) continue;
                
                records.push({
                    sl: row[colMap.sl] || records.length + 1,
                    name: name,
                    designation: String(row[colMap.designation] || '').trim(),
                    grossSalary: parseFloat(row[colMap.grossSalary]) || 0,
                    taxDeduction: parseFloat(row[colMap.taxDeduction]) || 0,
                    payCash: parseFloat(row[colMap.payCash]) || 0,
                    payBank: parseFloat(row[colMap.payBank]) || 0,
                    netPay: parseFloat(row[colMap.netPay]) || 0,
                    bankAccount: row[colMap.bankAccount] ? String(row[colMap.bankAccount]) : '',
                    branch: String(row[colMap.branch] || '').trim(),
                    remarks: String(row[colMap.remarks] || '').trim()
                });
            }
            
            return {
                monthKey,
                monthLabel,
                records
            };
        }
        
        // Update salary month selector with available months
        function updateSalaryMonthSelector() {
            const select = document.getElementById('salaryMonth');
            if (!select) return;
            
            const salaryRecords = getSalaryRecordsFromStorage();
            const months = Object.keys(salaryRecords).sort().reverse();
            
            select.innerHTML = '<option value="">Select Month</option>';
            
            months.forEach(monthKey => {
                const option = document.createElement('option');
                option.value = monthKey;
                option.textContent = salaryRecords[monthKey].monthLabel || monthKey;
                select.appendChild(option);
            });
            
            // Auto-select most recent if available
            if (months.length > 0) {
                select.value = months[0];
            }
        }
        
        // Load salary data for selected month
        function loadSalaryData() {
            const select = document.getElementById('salaryMonth');
            const selectedMonth = select?.value;
            
            const tableContainer = document.getElementById('salaryTableContainer');
            const noDataDiv = document.getElementById('salaryNoData');
            const summaryCards = document.getElementById('salarySummaryCards');
            const exportBtn = document.getElementById('exportSalaryBtn');
            
            if (!selectedMonth) {
                tableContainer.style.display = 'none';
                noDataDiv.style.display = 'block';
                summaryCards.style.display = 'none';
                exportBtn.style.display = 'none';
                return;
            }
            
            const salaryRecords = getSalaryRecordsFromStorage();
            const monthData = salaryRecords[selectedMonth];
            
            if (!monthData || !monthData.records || monthData.records.length === 0) {
                tableContainer.style.display = 'none';
                noDataDiv.style.display = 'block';
                summaryCards.style.display = 'none';
                exportBtn.style.display = 'none';
                return;
            }
            
            // Show data
            tableContainer.style.display = 'block';
            noDataDiv.style.display = 'none';
            summaryCards.style.display = 'grid';
            exportBtn.style.display = 'flex';
            
            // Calculate totals
            let totalGross = 0, totalTax = 0, totalNet = 0;
            monthData.records.forEach(r => {
                totalGross += r.grossSalary || 0;
                totalTax += r.taxDeduction || 0;
                totalNet += r.netPay || r.grossSalary - r.taxDeduction || 0;
            });
            
            // Update summary cards
            document.getElementById('totalGrossSalary').textContent = `৳${totalGross.toLocaleString()}`;
            document.getElementById('totalDeductions').textContent = `৳${totalTax.toLocaleString()}`;
            document.getElementById('totalNetSalary').textContent = `৳${totalNet.toLocaleString()}`;
            document.getElementById('employeesPaid').textContent = monthData.records.length;
            
            // Populate table
            const tbody = document.getElementById('salaryTableBody');
            tbody.innerHTML = '';
            
            monthData.records.forEach((record, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="color: var(--color-text-muted);">${record.sl || index + 1}</td>
                    <td style="font-weight: 600;">${record.name}</td>
                    <td style="font-size: 13px; color: var(--color-text-muted);">${record.designation || '-'}</td>
                    <td style="color: var(--color-success); font-weight: 600;">৳${(record.grossSalary || 0).toLocaleString()}</td>
                    <td style="color: var(--color-danger);">৳${(record.taxDeduction || 0).toLocaleString()}</td>
                    <td>৳${(record.payCash || 0).toLocaleString()}</td>
                    <td>৳${(record.payBank || 0).toLocaleString()}</td>
                    <td style="color: var(--color-primary); font-weight: 600;">৳${(record.netPay || 0).toLocaleString()}</td>
                `;
                tbody.appendChild(row);
            });
            
            lucide.createIcons();
        }
        
        // Export salary data to Excel
        function exportSalaryToExcel() {
            const select = document.getElementById('salaryMonth');
            const selectedMonth = select?.value;
            
            if (!selectedMonth) {
                showNotification('Please select a month first', 'warning');
                return;
            }
            
            const salaryRecords = getSalaryRecordsFromStorage();
            const monthData = salaryRecords[selectedMonth];
            
            if (!monthData || !monthData.records || monthData.records.length === 0) {
                showNotification('No salary data to export', 'warning');
                return;
            }
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Create header rows (matching original format)
            const headerRows = [
                ['', 'INDIGO FASHION'],
                ['', 'Monthly Salary Chart'],
                ['', monthData.monthLabel || selectedMonth],
                [''],
                ['', 'SL NO', 'Name', 'Designation', 'Gross Salary', 'Tax deduction', 'Pay to cash', 'Pay to Bank', 'Net Pay', 'Bank Account No.', 'Branch', 'Remarks']
            ];
            
            // Add data rows
            const dataRows = monthData.records.map(r => [
                '',
                r.sl,
                r.name,
                r.designation,
                r.grossSalary,
                r.taxDeduction || '',
                r.payCash || '',
                r.payBank || '',
                r.netPay,
                r.bankAccount || '',
                r.branch || '',
                r.remarks || ''
            ]);
            
            // Combine all rows
            const allRows = [...headerRows, ...dataRows];
            
            // Create worksheet
            const ws = XLSX.utils.aoa_to_array ? XLSX.utils.aoa_to_sheet(allRows) : XLSX.utils.aoa_to_sheet(allRows);
            
            // Add to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Salary');
            
            // Generate filename
            const filename = `Indigo_Fashion_Salary_${monthData.monthLabel || selectedMonth}.xlsx`;
            
            // Download
            XLSX.writeFile(wb, filename);
            showNotification(`Salary report exported: ${filename}`);
        }
        
        // Export employee directory to Excel
        function exportEmployeeDirectory() {
            const employees = getEmployeesFromStorage();
            
            if (!employees || employees.length === 0) {
                showNotification('No employees to export', 'warning');
                return;
            }
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Create header rows
            const headerRows = [
                ['INDIGO FASHION'],
                ['Employee Directory'],
                [new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' })],
                [''],
                ['SL NO', 'Name', 'Designation', 'Department', 'Shift', 'Status', 'Left Date', 'Reason']
            ];
            
            // Add data rows - active first, then left
            const sortedEmployees = [...employees].sort((a, b) => {
                if (a.status === 'active' && b.status !== 'active') return -1;
                if (a.status !== 'active' && b.status === 'active') return 1;
                return a.name.localeCompare(b.name);
            });
            
            const dataRows = sortedEmployees.map((emp, index) => {
                const shift = emp.shift || getEmployeeShift(emp.name);
                const shiftText = shift === 1 ? '1st Shift (9AM-7PM)' : '2nd Shift (10:30AM-8:30PM)';
                
                return [
                    index + 1,
                    emp.name,
                    emp.role || '',
                    emp.department || '',
                    shiftText,
                    emp.status === 'left' ? 'Left' : 'Active',
                    emp.leftDate || '',
                    emp.leftReason || ''
                ];
            });
            
            // Combine all rows
            const allRows = [...headerRows, ...dataRows];
            
            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(allRows);
            
            // Add to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Employee Directory');
            
            // Generate filename
            const filename = `Indigo_Fashion_Employee_Directory_${new Date().toISOString().slice(0, 10)}.xlsx`;
            
            // Download
            XLSX.writeFile(wb, filename);
            showNotification(`Employee directory exported: ${filename}`);
        }

        // ============================================
        // SALARY & PAYROLL FUNCTIONS
        // ============================================
        
        // Calculate salary with deductions (using attendance records)
        function calculateSalaryWithDeductions(employee, month = null) {
            const gross = employee.monthlySalary || 0;
            
            // Use current month if not specified
            const calcMonth = month || new Date();
            
            // Calculate deductions from attendance
            const attendanceDeductions = calculateTotalDeductionsForEmployee(employee, attendanceRecords, calcMonth);
            
            // Other deduction types
            const taxRate = 0.10; // 10% tax
            const providentFund = gross * 0.05; // 5% PF
            const incomeTax = gross > 30000 ? gross * taxRate : 0;
            const advance = employee.advance || 0;
            const otherDeductions = employee.otherDeductions || 0;
            
            // Late deduction from attendance (3 late days = 1 day salary)
            const lateDeduction = attendanceDeductions.lateDeduction;
            
            // UL deduction (Unauthorized Leave = full day deducted)
            const ulDeduction = attendanceDeductions.ulDeduction;
            
            const totalDeductions = incomeTax + providentFund + advance + lateDeduction + ulDeduction + otherDeductions;
            const net = gross - totalDeductions;
            
            return {
                gross: gross,
                incomeTax: incomeTax,
                providentFund: providentFund,
                advance: advance,
                lateDeduction: lateDeduction,
                lateDays: attendanceDeductions.lateDays,
                ulDeduction: ulDeduction,
                ulDays: attendanceDeductions.ulDays,
                earlyLeaveDays: attendanceDeductions.earlyLeaveDays,
                otherDeductions: otherDeductions,
                totalDeductions: totalDeductions,
                net: net,
                deductions: [
                    { name: 'Income Tax', amount: incomeTax, icon: 'receipt' },
                    { name: 'Provident Fund', amount: providentFund, icon: 'piggy-bank' },
                    { name: 'Advance', amount: advance, icon: 'credit-card' },
                    { name: `Late (${attendanceDeductions.lateDays} days, ${attendanceDeductions.lateDays >= 3 ? Math.floor(attendanceDeductions.lateDays / 3) + ' day(s) deducted' : '0 days deducted'})`, amount: lateDeduction, icon: 'clock' },
                    { name: `Unauthorized Leave (${attendanceDeductions.ulDays} day${attendanceDeductions.ulDays !== 1 ? 's' : ''})`, amount: ulDeduction, icon: 'calendar-x' },
                    { name: 'Others', amount: otherDeductions, icon: 'minus-circle' }
                ].filter(d => d.amount > 0)
            };
        }
        
        // Export all submitted expenses to Excel
        function exportSubmittedExpenses() {
            const expenses = getExpensesFromStorage();
            
            if (expenses.length === 0) {
                showNotification('No expenses to export');
                return;
            }
            
            // Prepare data for Excel
            const excelData = expenses.map(exp => ({
                'Date': exp.date || new Date(exp.submittedAt).toISOString().split('T')[0],
                'Description': exp.description,
                'Category': exp.category,
                'Amount (৳)': exp.amount,
                'Status': exp.status,
                'Requested By': exp.requestedBy || 'Ritu',
                'Approved By': exp.approvedBy || '-',
                'Approved Date': exp.approvedAt || '-',
                'Rejection Reason': exp.rejectionReason || '-'
            }));
            
            // Create worksheet
            const ws = XLSX.utils.json_to_sheet(excelData);
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Submitted Expenses');
            
            // Generate filename with current date
            const today = new Date().toISOString().split('T')[0];
            const filename = `Indigo_Submitted_Expenses_${today}.xlsx`;
            
            // Download
            XLSX.writeFile(wb, filename);
            
            showNotification(`✓ Exported ${expenses.length} expenses to Excel`);
        }

        function loadAttendanceTable() {
            const tbody = document.getElementById('attendanceTableBody');
            tbody.innerHTML = '';
            
            // Load from localStorage first
            const storedRecords = getAttendanceFromStorage();
            
            // Merge with existing attendanceData (prefer localStorage)
            let allRecords = [...storedRecords];
            
            // If no stored records, fall back to embedded data
            if (allRecords.length === 0 && excelAttendanceData.length > 0) {
                allRecords = excelAttendanceData.map((att, index) => ({
                    id: index + 1,
                    name: att.name.toUpperCase(),
                    date: parseExcelDateString(att.date),
                    clockIn: att.clockIn || '',
                    clockOut: att.clockOut || '',
                    late: att.late || '',
                    absent: att.absent || '',
                    shift: getEmployeeShift(att.name),
                    status: att.absent ? 'Absent' : (att.late ? 'Late' : 'Present'),
                    isLate: att.late && att.late !== '',
                    isEarlyLeave: false
                }));
            }
            
            const selectedMonth = document.getElementById('attendanceMonth')?.value || '2025-11';
            const [year, month] = selectedMonth.split('-').map(Number);
            
            // Filter by month
            const monthRecords = allRecords.filter(att => {
                const attDate = new Date(att.date);
                return attDate.getMonth() === month - 1 && attDate.getFullYear() === year;
            });
            
            // Sort by date descending, then by name
            monthRecords.sort((a, b) => {
                const dateCompare = new Date(b.date) - new Date(a.date);
                if (dateCompare !== 0) return dateCompare;
                return a.name.localeCompare(b.name);
            });
            
            // Show/hide empty state
            const emptyState = document.getElementById('attendanceEmptyState');
            const table = document.getElementById('attendanceTable');
            
            if (monthRecords.length === 0) {
                if (emptyState) emptyState.style.display = 'block';
                if (table) table.style.display = 'none';
                return;
            } else {
                if (emptyState) emptyState.style.display = 'none';
                if (table) table.style.display = 'table';
            }
            
            monthRecords.forEach(att => {
                const shift = att.shift || 2;
                const shiftText = shift === 1 ? '1st (9-7)' : '2nd (10:30-8:30)';
                const clockIn = att.clockIn || '-';
                const clockOut = att.clockOut || '-';
                
                // Determine status badge
                let statusBadge = 'status-approved';
                let statusText = att.status || 'Present';
                
                if (att.status === 'Late' || att.isLate) {
                    statusBadge = 'status-pending';
                    statusText = 'Late';
                } else if (att.status === 'Absent') {
                    statusBadge = 'status-rejected';
                    statusText = 'Absent';
                }
                
                // Check for early leave
                const isEarly = att.isEarlyLeave;
                
                // Late time display
                const lateTime = att.late || '';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(att.date).toLocaleDateString()}</td>
                    <td style="font-weight: 600; color: #000;">${att.name}</td>
                    <td style="font-size: 12px; color: var(--color-text-muted);">${shiftText}</td>
                    <td style="font-family: monospace; font-size: 13px;">${clockIn}</td>
                    <td style="font-family: monospace; font-size: 13px;">${clockOut} ${isEarly ? '<span style="color: var(--color-warning);" title="Early Leave">⚠️</span>' : ''}</td>
                    <td>
                        <span class="status-badge ${statusBadge}">${statusText}</span>
                        ${isEarly ? '<span style="margin-left: 6px; font-size: 11px; color: var(--color-warning);">Early</span>' : ''}
                    </td>
                    <td style="font-family: monospace; font-size: 12px; color: ${lateTime ? 'var(--color-warning)' : 'var(--color-text-muted)'};">${lateTime || '-'}</td>
                `;
                tbody.appendChild(row);
            });
            
            // Update summary cards
            updateAttendanceSummaryCards();
        }
        
        // Parse date string like "03-Nov-25" to ISO format
        function parseExcelDateString(dateStr) {
            if (!dateStr) return '';
            
            // Handle "03-Nov-25" format
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                const day = parts[0];
                const monthStr = parts[1];
                let year = parts[2];
                
                // Convert 2-digit year to 4-digit
                if (year.length === 2) {
                    year = '20' + year;
                }
                
                const months = {
                    'Jan': '01', 'Feb': '02', 'Mar': '03', 'Apr': '04',
                    'May': '05', 'Jun': '06', 'Jul': '07', 'Aug': '08',
                    'Sep': '09', 'Oct': '10', 'Nov': '11', 'Dec': '12'
                };
                
                const month = months[monthStr] || '01';
                return `${year}-${month}-${day.padStart(2, '0')}`;
            }
            
            return dateStr;
        }
        
        // ============================================
        // ATTENDANCE EXCEL UPLOAD FUNCTIONS
        // ============================================
        
        // Get attendance from localStorage
        function getAttendanceFromStorage() {
            const stored = localStorage.getItem('indigoAttendanceRecords');
            return stored ? JSON.parse(stored) : [];
        }
        
        // Save attendance to localStorage
        function saveAttendanceToStorage(records) {
            localStorage.setItem('indigoAttendanceRecords', JSON.stringify(records));
            // Also save last upload timestamp
            localStorage.setItem('indigoAttendanceLastUpload', new Date().toISOString());
        }
        
        // Setup attendance drop zone
        function setupAttendanceDropZone() {
            const dropZone = document.getElementById('attendanceDropZone');
            if (!dropZone) return;
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.add('drag-over');
                }, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.remove('drag-over');
                }, false);
            });
            
            dropZone.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleAttendanceExcel(files[0]);
                }
            }, false);
            
            // Click to upload
            dropZone.addEventListener('click', (e) => {
                if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT') {
                    document.getElementById('attendanceFileInput').click();
                }
            });
        }
        
        // Handle attendance Excel file upload
        function handleAttendanceExcel(file) {
            if (!file) return;
            
            // Validate file type
            const validTypes = ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 
                              'application/vnd.ms-excel'];
            if (!validTypes.includes(file.type) && !file.name.match(/\.(xlsx|xls)$/i)) {
                showNotification('Please upload a valid Excel file (.xlsx or .xls)');
                return;
            }
            
            // Show loading state
            document.getElementById('attendanceDropContent').style.display = 'none';
            document.getElementById('attendanceUploadProgress').style.display = 'block';
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Get first sheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convert to JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // Parse and save the attendance data
                    parseAttendanceExcel(jsonData, file.name);
                    
                } catch (error) {
                    console.error('Error parsing Excel file:', error);
                    showNotification('Error parsing Excel file. Please check the format.');
                    resetAttendanceUploadUI();
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // Parse attendance Excel data
        function parseAttendanceExcel(data, fileName) {
            if (!data || data.length < 2) {
                showNotification('Excel file appears to be empty or invalid');
                resetAttendanceUploadUI();
                return;
            }
            
            // Get existing records
            const existingRecords = getAttendanceFromStorage();
            const newRecords = [];
            let latestDate = null;
            
            // Find header row (look for "Name" or similar)
            let headerRowIndex = 0;
            for (let i = 0; i < Math.min(5, data.length); i++) {
                const row = data[i];
                if (row && row.some(cell => 
                    cell && typeof cell === 'string' && 
                    (cell.toLowerCase().includes('name') || cell.toLowerCase().includes('date'))
                )) {
                    headerRowIndex = i;
                    break;
                }
            }
            
            // Parse data rows
            for (let i = headerRowIndex + 1; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length === 0 || !row[0]) continue;
                
                try {
                    // Expected format: Name | Date | Clock In | Clock Out | Late | Absent
                    const name = String(row[0] || '').trim();
                    if (!name) continue;
                    
                    // Parse date
                    let dateValue = row[1];
                    let parsedDate = null;
                    
                    if (typeof dateValue === 'number') {
                        // Excel serial date
                        const excelEpoch = new Date(1899, 11, 30);
                        parsedDate = new Date(excelEpoch.getTime() + dateValue * 86400000);
                    } else if (typeof dateValue === 'string') {
                        parsedDate = new Date(dateValue);
                    } else if (dateValue instanceof Date) {
                        parsedDate = dateValue;
                    }
                    
                    if (!parsedDate || isNaN(parsedDate.getTime())) continue;
                    
                    const dateStr = parsedDate.toISOString().split('T')[0];
                    
                    // Track latest date
                    if (!latestDate || parsedDate > latestDate) {
                        latestDate = parsedDate;
                    }
                    
                    // Parse times
                    const clockIn = parseExcelTime(row[2]);
                    const clockOut = parseExcelTime(row[3]);
                    const late = String(row[4] || '').trim();
                    const absent = String(row[5] || '').trim();
                    
                    // Determine shift based on employee name
                    const firstShiftEmployees = ['Ritu', 'Shila', 'Arnob', 'Arnab', 'Badiul', 'Bodiuzzaman'];
                    const isFirstShift = firstShiftEmployees.some(n => name.toLowerCase().includes(n.toLowerCase()));
                    const shift = isFirstShift ? 1 : 2;
                    
                    // Determine status
                    let status = 'Present';
                    let isLateRecord = false;
                    
                    if (absent && absent !== '') {
                        status = 'Absent';
                    } else if (late && late !== '') {
                        status = 'Late';
                        isLateRecord = true;
                    } else if (clockIn) {
                        // Check if late based on shift
                        const [hours, minutes] = clockIn.split(':').map(Number);
                        const clockInMinutes = hours * 60 + minutes;
                        const shiftStart = isFirstShift ? 9 * 60 : 10 * 60 + 30; // 9:00 or 10:30
                        if (clockInMinutes > shiftStart) {
                            isLateRecord = true;
                        }
                    }
                    
                    // Check for early leave
                    let isEarlyLeave = false;
                    if (clockOut) {
                        const [hours, minutes] = clockOut.split(':').map(Number);
                        const clockOutMinutes = hours * 60 + minutes;
                        const shiftEnd = isFirstShift ? 19 * 60 : 20 * 60 + 30; // 19:00 or 20:30
                        if (clockOutMinutes < shiftEnd) {
                            isEarlyLeave = true;
                        }
                    }
                    
                    // Create record
                    const record = {
                        id: Date.now() + i,
                        name: name.toUpperCase(),
                        date: dateStr,
                        clockIn: clockIn || '',
                        clockOut: clockOut || '',
                        late: late,
                        absent: absent,
                        shift: shift,
                        status: status,
                        isLate: isLateRecord,
                        isEarlyLeave: isEarlyLeave,
                        uploadedAt: new Date().toISOString(),
                        fileName: fileName
                    };
                    
                    newRecords.push(record);
                    
                } catch (err) {
                    console.warn('Error parsing row', i, err);
                }
            }
            
            if (newRecords.length === 0) {
                showNotification('No valid attendance records found in file');
                resetAttendanceUploadUI();
                return;
            }
            
            // Append to existing records (avoid duplicates by checking name+date)
            const existingKeys = new Set(existingRecords.map(r => `${r.name}-${r.date}`));
            let addedCount = 0;
            let updatedCount = 0;
            
            newRecords.forEach(record => {
                const key = `${record.name}-${record.date}`;
                if (existingKeys.has(key)) {
                    // Update existing record
                    const existingIndex = existingRecords.findIndex(r => `${r.name}-${r.date}` === key);
                    if (existingIndex !== -1) {
                        existingRecords[existingIndex] = { ...existingRecords[existingIndex], ...record };
                        updatedCount++;
                    }
                } else {
                    existingRecords.push(record);
                    addedCount++;
                }
            });
            
            // Save to localStorage
            saveAttendanceToStorage(existingRecords);
            
            // Update the global attendanceData array for display
            updateAttendanceDataFromStorage();
            
            // Show success message
            const latestDateStr = latestDate ? latestDate.toLocaleDateString() : 'N/A';
            showAttendanceUploadSuccess(addedCount, updatedCount, latestDateStr, fileName);
            
            // Update summary cards
            updateAttendanceSummaryCards();
            
            // Reload table
            loadAttendanceTable();
            
            // Reset upload UI
            resetAttendanceUploadUI();
            
            showNotification(`✓ Processed ${newRecords.length} attendance records`);
        }
        
        // Parse Excel time value
        function parseExcelTime(value) {
            if (!value) return '';
            
            if (typeof value === 'number') {
                // Excel time as fraction of day
                const totalMinutes = Math.round(value * 24 * 60);
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            }
            
            if (typeof value === 'string') {
                // Already a time string
                const match = value.match(/(\d{1,2}):(\d{2})/);
                if (match) {
                    return `${match[1].padStart(2, '0')}:${match[2]}`;
                }
            }
            
            return '';
        }
        
        // Update attendanceData from localStorage
        function updateAttendanceDataFromStorage() {
            const storedRecords = getAttendanceFromStorage();
            
            // Convert to the format expected by the app
            attendanceData = storedRecords.map((record, index) => ({
                id: record.id || index + 1,
                employeeId: null,
                employee: record.name,
                date: record.date,
                shift: record.shift || 2,
                clockInTime: record.clockIn ? `${record.date}T${record.clockIn}:00` : null,
                clockOutTime: record.clockOut ? `${record.date}T${record.clockOut}:00` : null,
                status: record.status || 'Present',
                leaveType: record.absent ? 'UL' : null,
                earlyLeave: record.isEarlyLeave || false
            }));
        }
        
        // Show upload success message
        function showAttendanceUploadSuccess(added, updated, latestDate, fileName) {
            const successDiv = document.getElementById('attendanceUploadSuccess');
            const titleEl = document.getElementById('attendanceSuccessTitle');
            const detailsEl = document.getElementById('attendanceSuccessDetails');
            
            titleEl.textContent = `Upload Successful!`;
            detailsEl.textContent = `Added ${added} new records, updated ${updated} existing. Latest date: ${latestDate}`;
            
            successDiv.style.display = 'flex';
            
            // Hide after 5 seconds
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 5000);
        }
        
        // Reset upload UI
        function resetAttendanceUploadUI() {
            document.getElementById('attendanceDropContent').style.display = 'block';
            document.getElementById('attendanceUploadProgress').style.display = 'none';
            document.getElementById('attendanceFileInput').value = '';
        }
        
        // Update attendance summary cards
        function updateAttendanceSummaryCards() {
            const records = getAttendanceFromStorage();
            const lastUpload = localStorage.getItem('indigoAttendanceLastUpload');
            
            // Total records
            document.getElementById('attendanceTotalRecords').textContent = records.length;
            
            // Unique employees
            const uniqueEmployees = [...new Set(records.map(r => r.name.toUpperCase()))];
            document.getElementById('attendanceUniqueEmployees').textContent = uniqueEmployees.length;
            
            // Late count
            const lateCount = records.filter(r => r.isLate || (r.late && r.late !== '')).length;
            document.getElementById('attendanceLateCount').textContent = lateCount;
            
            // Last upload
            if (lastUpload) {
                const uploadDate = new Date(lastUpload);
                const now = new Date();
                const diffMs = now - uploadDate;
                const diffMins = Math.floor(diffMs / 60000);
                
                let timeAgo;
                if (diffMins < 1) {
                    timeAgo = 'Just now';
                } else if (diffMins < 60) {
                    timeAgo = `${diffMins}m ago`;
                } else if (diffMins < 1440) {
                    timeAgo = `${Math.floor(diffMins / 60)}h ago`;
                } else {
                    timeAgo = uploadDate.toLocaleDateString();
                }
                document.getElementById('attendanceLastUpload').textContent = timeAgo;
            }
            
            // Show/hide empty state
            const emptyState = document.getElementById('attendanceEmptyState');
            const table = document.getElementById('attendanceTable');
            if (records.length === 0) {
                emptyState.style.display = 'block';
                table.style.display = 'none';
            } else {
                emptyState.style.display = 'none';
                table.style.display = 'table';
            }
        }
        
        // Export attendance data
        function exportAttendanceData() {
            const records = getAttendanceFromStorage();
            
            if (records.length === 0) {
                showNotification('No attendance records to export');
                return;
            }
            
            // Prepare data for Excel
            const excelData = records.map(r => ({
                'Name': r.name,
                'Date': r.date,
                'Clock In': r.clockIn || '-',
                'Clock Out': r.clockOut || '-',
                'Shift': r.shift === 1 ? '1st (9-7)' : '2nd (10:30-8:30)',
                'Status': r.status,
                'Late': r.isLate ? 'Yes' : 'No',
                'Early Leave': r.isEarlyLeave ? 'Yes' : 'No'
            }));
            
            // Create worksheet
            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Attendance Records');
            
            // Download
            const today = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `Indigo_Attendance_Export_${today}.xlsx`);
            
            showNotification(`✓ Exported ${records.length} attendance records`);
        }
        
        // Clear all attendance data
        function clearAttendanceData() {
            if (!confirm('Are you sure you want to clear ALL attendance records? This cannot be undone.')) {
                return;
            }
            
            localStorage.removeItem('indigoAttendanceRecords');
            localStorage.removeItem('indigoAttendanceLastUpload');
            attendanceData = [];
            
            updateAttendanceSummaryCards();
            loadAttendanceTable();
            
            showNotification('All attendance records cleared');
        }
        
        // Pre-load November 2025 attendance data into localStorage
        function preloadNovemberAttendanceData() {
            const existingRecords = getAttendanceFromStorage();
            
            // Only pre-load if localStorage is empty
            if (existingRecords.length === 0 && novemberAttendanceData.length > 0) {
                console.log('Pre-loading November 2025 attendance data (201 records)...');
                
                // Convert novemberAttendanceData to the storage format
                const recordsToStore = novemberAttendanceData.map((att, index) => {
                    // Determine shift based on employee name
                    const firstShiftEmployees = ['RITU', 'SHILA', 'ARNOB', 'ARNAB', 'BADIUL', 'BODIUZZAMAN'];
                    const isFirstShift = firstShiftEmployees.some(n => att.name.toUpperCase().includes(n));
                    const shift = isFirstShift ? 1 : 2;
                    
                    // Determine if late
                    const isLate = att.late && att.late !== '';
                    
                    // Check for early leave
                    let isEarlyLeave = false;
                    if (att.clockOut) {
                        const [hours, minutes] = att.clockOut.split(':').map(Number);
                        const clockOutMinutes = hours * 60 + minutes;
                        const shiftEnd = isFirstShift ? 19 * 60 : 20 * 60 + 30;
                        if (clockOutMinutes < shiftEnd) {
                            isEarlyLeave = true;
                        }
                    }
                    
                    return {
                        id: Date.now() + index,
                        name: att.name.toUpperCase(),
                        date: att.date,
                        clockIn: att.clockIn || '',
                        clockOut: att.clockOut || '',
                        late: att.late || '',
                        absent: att.absent || '',
                        shift: shift,
                        status: att.absent ? 'Absent' : (isLate ? 'Late' : 'Present'),
                        isLate: isLate,
                        isEarlyLeave: isEarlyLeave,
                        uploadedAt: new Date().toISOString(),
                        fileName: 'Attendance of Nov-2025 (2).xlsx (Pre-loaded)'
                    };
                });
                
                // Save to localStorage
                saveAttendanceToStorage(recordsToStore);
                console.log(`✓ Pre-loaded ${recordsToStore.length} attendance records`);
            }
        }

        // ============================================
        // SESSION CHECK & LOGOUT
        // ============================================
        
        // Check if user came through proper login
        function checkEmployeeSession() {
            const isLoggedIn = sessionStorage.getItem('indigoEmployeeLoggedIn');
            if (isLoggedIn !== 'true') {
                // Not logged in - redirect to login page
                window.location.href = 'index.html';
                return false;
            }
            return true;
        }
        
        // Logout function - returns to PIN screen
        function logout() {
            sessionStorage.removeItem('indigoEmployeeLoggedIn');
            window.location.href = 'index.html';
        }
        
        // Make logout available globally
        window.logout = logout;

        // Dashboard Initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Check session - redirect if not logged in
            if (!checkEmployeeSession()) return;
            
            // Clear test data function (available in console)
            window.clearTestData = function() {
                localStorage.removeItem('indigoExpenses');
                localStorage.removeItem('indigoBossNotifications');
                localStorage.removeItem('indigoNotifications');
                localStorage.removeItem('indigoSalaryRecords');
                console.log('✅ All test data cleared from localStorage');
                console.log('Reload the page to see clean data');
            };
            console.log('💡 Tip: Run clearTestData() in console to clear all test localStorage data');
            
            // Initialize salary features
            setupSalaryDropZone();
            updateSalaryMonthSelector();
            loadSalaryData();
            
            // Calculate today's attendance stats
            const today = new Date().toISOString().split('T')[0];
            const todayAttendance = attendanceData.filter(att => att.date === today);
            
            const presentCount = todayAttendance.filter(att => att.status === 'Present' || att.status === 'Late' || (att.status === 'Absent' && att.leaveType === 'AL')).length;
            const lateCount = todayAttendance.filter(att => {
                if (att.status === 'Late') return true;
                const emp = employees.find(e => e.id === att.employeeId || e.name === att.employee);
                return emp && att.clockInTime && isLate(att.clockInTime, emp.name);
            }).length;
            const earlyLeaveCount = todayAttendance.filter(att => {
                if (att.earlyLeave) return true;
                const emp = employees.find(e => e.id === att.employeeId || e.name === att.employee);
                return emp && att.clockOutTime && isEarlyLeave(att.clockOutTime, emp.name);
            }).length;
            
            document.getElementById('presentTodayCount').textContent = presentCount;
            document.getElementById('lateTodayCount').textContent = lateCount;
            document.getElementById('earlyLeaveTodayCount').textContent = earlyLeaveCount;
            
            // Count pending expenses from localStorage
            const storedExpenses = getExpensesFromStorage();
            const pendingExpensesCount = storedExpenses.filter(exp => exp.status === 'Pending').length;
            document.getElementById('pendingExpensesCount').textContent = pendingExpensesCount + expenses.length;
            
            document.getElementById('openOrdersCount').textContent = getOrdersFromStorage().length;
            
            // Load rejection notifications on page load
            loadRejectionNotifications();
            
            // Update message badge
            updateMessageBadge();
            
            // Populate Recent Activities (Ritu's activities only)
            const activitiesBody = document.getElementById('activitiesTableBody');
            activitiesBody.innerHTML = `
                <tr>
                    <td>Today</td>
                    <td>Ritu</td>
                    <td>Attendance</td>
                    <td>Clocked in at 9:05 AM</td>
                    <td><span class="status-badge status-approved">Present</span></td>
                </tr>
                <tr>
                    <td>Yesterday</td>
                    <td>Ritu</td>
                    <td>Expense</td>
                    <td>Office supplies (৳1,500)</td>
                    <td><span class="status-badge status-approved">Auto-Approved</span></td>
                </tr>
            `;
            
            // Setup Excel drag and drop for expenses
            setupExcelDropZone();
            
            // Setup Attendance Excel drag and drop
            setupAttendanceDropZone();
            
            // Pre-load November 2025 attendance data into localStorage if empty
            preloadNovemberAttendanceData();
            
            // Load attendance from localStorage and update summary
            updateAttendanceDataFromStorage();
            updateAttendanceSummaryCards();
            
            lucide.createIcons();
        });
        
        // Notification function
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 24px;
                right: 24px;
                background: var(--color-bg-card);
                border: var(--glass-border);
                border-radius: 12px;
                padding: 16px 20px;
                color: #000;
                font-size: 14px;
                font-weight: 500;
                z-index: 10000;
                box-shadow: var(--glass-shadow);
                backdrop-filter: blur(16px);
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.transition = 'opacity 0.3s ease';
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Form handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Process Payroll Form
            const processPayrollForm = document.getElementById('processPayrollForm');
            if (processPayrollForm) {
                processPayrollForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const month = document.getElementById('payrollMonth').value;
                    const paymentDate = document.getElementById('paymentDate').value;
                    const paymentMethod = document.getElementById('paymentMethod').value;
                    
                    // Process payroll for all employees
                    employees.forEach(emp => {
                        emp.payrollStatus = 'paid';
                    });
                    
                    showNotification(`Payroll processed for ${month} successfully!`);
                    hideModal('processPayroll');
                    loadSalaryData();
                });
            }
            
            // Add Expense Form - New implementation with auto-approval
            const addExpenseForm = document.getElementById('addExpenseForm');
            if (addExpenseForm) {
                addExpenseForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Get form values
                    const description = document.getElementById('expenseDescription').value.trim();
                    const amount = parseFloat(document.getElementById('expenseAmount').value);
                    const category = document.getElementById('expenseCategory').value;
                    
                    // Validate
                    if (!description || !amount || amount <= 0) {
                        showNotification('Please fill in all fields correctly');
                        return;
                    }
                    
                    // Generate ID and timestamps
                    const expenseId = generateExpenseId();
                    const currentDate = new Date();
                    const dateStr = currentDate.toISOString().split('T')[0]; // YYYY-MM-DD
                    const submittedAt = currentDate.toISOString();
                    
                    // Determine status based on amount
                    const status = amount < 5000 ? 'Auto-Approved' : 'Pending';
                    
                    // Create expense object
                    const expense = {
                        id: expenseId,
                        date: dateStr,
                        description: description,
                        category: category,
                        amount: amount,
                        requestedBy: 'Ritu',
                        status: status,
                        rejectionReason: null,
                        approvedBy: null,
                        approvedAt: null,
                        submittedAt: submittedAt,
                        isNew: true
                    };
                    
                    // Save expense to localStorage
                    // Save to Supabase (fallback to localStorage)
                    if (supabaseAvailable) {
                        const result = await insertExpensesToSupabase([{
                            employee: expense.requestedBy,
                            description: expense.description,
                            amount: expense.amount,
                            category: expense.category,
                            date: expense.date
                        }]);
                        
                        if (!result.success) {
                            console.warn('Supabase insert failed, falling back to localStorage');
                            saveExpenseToStorage(expense);
                        }
                    } else {
                        saveExpenseToStorage(expense);
                    }
                    
                    // Create boss notification ONLY for high-value expenses (>= 5000)
                    if (amount >= 5000 && supabaseAvailable) {
                        await insertMessageToSupabase({
                            sender: 'employee',
                            content: `New expense submitted: ${description} - ৳${amount}`,
                            read: false
                        });
                    }
                    
                    // Show success message
                    if (status === 'Auto-Approved') {
                        showNotification('✓ Expense auto-approved (under ৳5000)');
                    } else {
                        showNotification('✓ Expense submitted for approval (≥ ৳5000)');
                    }
                    
                    // Update expenses table
                    if (document.getElementById('expenses').classList.contains('hidden') === false) {
                        loadExpensesTable();
                    }
                    
                    // Reset form and close modal
                    addExpenseForm.reset();
                    hideModal('addExpense');
                });
            }
            
            // Quick Expense Form (from Add Expense Tab)
            const quickExpenseForm = document.getElementById('quickExpenseForm');
            if (quickExpenseForm) {
                quickExpenseForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Get form values
                    const description = document.getElementById('quickExpenseDescription').value.trim();
                    const amount = parseFloat(document.getElementById('quickExpenseAmount').value);
                    const category = document.getElementById('quickExpenseCategory').value;
                    
                    // Validate
                    if (!description || !amount || amount <= 0) {
                        showNotification('Please fill in all fields correctly');
                        return;
                    }
                    
                    // Generate ID and timestamps
                    const expenseId = generateExpenseId();
                    const currentDate = new Date();
                    const dateStr = currentDate.toISOString().split('T')[0]; // YYYY-MM-DD
                    const submittedAt = currentDate.toISOString();
                    
                    // Determine status based on amount
                    const status = amount < 5000 ? 'Auto-Approved' : 'Pending';
                    
                    // Create expense object
                    const expense = {
                        id: expenseId,
                        date: dateStr,
                        description: description,
                        category: category,
                        amount: amount,
                        requestedBy: 'Ritu',
                        status: status,
                        rejectionReason: null,
                        approvedBy: null,
                        approvedAt: null,
                        submittedAt: submittedAt,
                        isNew: true
                    };
                    
                    // Save to Supabase (fallback to localStorage)
                    if (supabaseAvailable) {
                        const result = await insertExpensesToSupabase([{
                            employee: expense.requestedBy,
                            description: expense.description,
                            amount: expense.amount,
                            category: expense.category,
                            date: expense.date
                        }]);
                        
                        if (!result.success) {
                            console.warn('Supabase insert failed, falling back to localStorage');
                            saveExpenseToStorage(expense);
                        }
                    } else {
                        saveExpenseToStorage(expense);
                    }
                    
                    // Create boss notification ONLY for high-value expenses (>= 5000)
                    if (amount >= 5000 && supabaseAvailable) {
                        await insertMessageToSupabase({
                            sender: 'employee',
                            content: `New expense submitted: ${description} - ৳${amount}`,
                            read: false
                        });
                    }
                    
                    // Show success message
                    if (status === 'Auto-Approved') {
                        showNotification('✓ Expense auto-approved (under ৳5000)');
                    } else {
                        showNotification('✓ Expense submitted for Boss approval (≥ ৳5000)');
                    }
                    
                    // Reset form
                    quickExpenseForm.reset();
                    
                    // Switch to expenses tab to show the new expense
                    showTab('expenses', document.querySelector('[data-i18n="expenses"]'));
                });
            }
            
            // Add Order Form
            const addOrderForm = document.getElementById('addOrderForm');
            if (addOrderForm) {
                // Live commission preview
                const fobInput = document.getElementById('orderFobValue');
                const costInput = document.getElementById('orderFactoryCost');
                const agentInput = document.getElementById('orderAgentCommission');
                
                function updateCommissionPreview() {
                    const fob = parseFloat(fobInput.value) || 0;
                    const cost = parseFloat(costInput.value) || 0;
                    const agentPercent = parseFloat(agentInput.value) || 0;
                    
                    const grossMargin = fob - cost;
                    const agentFee = fob * (agentPercent / 100);
                    const netCommission = grossMargin - agentFee;
                    
                    document.getElementById('previewGrossMargin').textContent = `$${grossMargin.toLocaleString()}`;
                    document.getElementById('previewAgentFee').textContent = `-$${agentFee.toLocaleString()}`;
                    document.getElementById('previewNetCommission').textContent = `$${netCommission.toLocaleString()}`;
                    document.getElementById('previewNetCommission').style.color = netCommission >= 0 ? 'var(--color-success)' : 'var(--color-danger)';
                }
                
                fobInput.addEventListener('input', updateCommissionPreview);
                costInput.addEventListener('input', updateCommissionPreview);
                agentInput.addEventListener('input', updateCommissionPreview);
                
                addOrderForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const newOrder = {
                        id: Date.now(),
                        orderNumber: document.getElementById('orderNumber').value.trim(),
                        clientName: document.getElementById('orderClientName').value.trim(),
                        factoryName: document.getElementById('orderFactoryName').value.trim(),
                        shipmentDate: document.getElementById('orderShipmentDate').value,
                        fobValue: parseFloat(document.getElementById('orderFobValue').value),
                        factoryCost: parseFloat(document.getElementById('orderFactoryCost').value),
                        agentName: document.getElementById('orderAgentName').value.trim() || null,
                        agentCommission: parseFloat(document.getElementById('orderAgentCommission').value) || 0,
                        status: document.getElementById('orderStatus').value,
                        createdAt: new Date().toISOString()
                    };
                    
                    saveOrderToStorage(newOrder);
                    showNotification(`✓ Order ${newOrder.orderNumber} added successfully!`);
                    hideModal('addOrder');
                    addOrderForm.reset();
                    document.getElementById('previewGrossMargin').textContent = '$0';
                    document.getElementById('previewAgentFee').textContent = '-$0';
                    document.getElementById('previewNetCommission').textContent = '$0';
                    loadOrdersTable();
                });
            }
            
            // Add Employee Form
            const addEmployeeForm = document.getElementById('addEmployeeForm');
            if (addEmployeeForm) {
                addEmployeeForm.addEventListener('submit', function(e) {
            e.preventDefault();
                    const newEmployee = {
                        id: employees.length + 1,
                        name: document.getElementById('employeeName').value,
                        role: document.getElementById('employeeRole').value,
                        department: document.getElementById('employeeDepartment').value,
                        monthlySalary: parseInt(document.getElementById('employeeSalary').value),
                        advance: 0,
                        lateDeduction: 0,
                        otherDeductions: 0,
                        payrollStatus: 'pending',
                        status: 'active'
                    };
                    
                    employees.push(newEmployee);
                    showNotification(`Employee ${newEmployee.name} added successfully!`);
                    hideModal('addEmployee');
                    loadEmployeesTable();
                    addEmployeeForm.reset();
                });
            }
        });

        // ============================================
        // EXCEL UPLOAD FUNCTIONALITY
        // ============================================
        
        // Setup drag and drop listeners
        function setupExcelDropZone() {
            const dropZone = document.getElementById('excelDropZone');
            
            if (dropZone) {
                // Prevent default drag behaviors
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, preventDefaults, false);
                    document.body.addEventListener(eventName, preventDefaults, false);
                });

                // Highlight drop zone when dragging over it
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropZone.addEventListener(eventName, () => {
                        dropZone.classList.add('drag-over');
                    }, false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, () => {
                        dropZone.classList.remove('drag-over');
                    }, false);
                });

                // Handle dropped files
                dropZone.addEventListener('drop', (e) => {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    if (files.length > 0) {
                        handleExcelFile(files[0]);
                    }
                }, false);

                // Click to upload
                dropZone.addEventListener('click', () => {
                    document.getElementById('excelFileInput').click();
                });
            }
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // Handle Excel file upload and parsing
        function handleExcelFile(file) {
            if (!file) return;

            // Validate file type
            const validTypes = ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 
                              'application/vnd.ms-excel'];
            if (!validTypes.includes(file.type) && !file.name.match(/\.(xlsx|xls)$/i)) {
                alert('Please upload a valid Excel file (.xlsx or .xls)');
                return;
            }

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Get first sheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convert to JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // Parse and validate the data
                    parseExcelExpenses(jsonData, file.name);
                    
                } catch (error) {
                    console.error('Error parsing Excel file:', error);
                    alert('Error parsing Excel file. Please ensure it has the correct format:\nDate | Description | Category | Amount');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Parse Excel data and append to expenses
        function parseExcelExpenses(data, fileName) {
            if (!data || data.length < 2) {
                alert('Excel file appears to be empty or invalid');
                return;
            }

            let successCount = 0;
            let errorCount = 0;
            const newExpenses = [];

            // Skip header row (index 0) and process data rows
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                
                // Skip empty rows
                if (!row || row.length === 0 || !row[0]) continue;

                try {
                    // Parse date (column 0)
                    let dateValue = row[0];
                    let formattedDate = '';
                    
                    if (typeof dateValue === 'number') {
                        // Excel date serial number
                        const excelDate = XLSX.SSF.parse_date_code(dateValue);
                        formattedDate = `${excelDate.y}-${String(excelDate.m).padStart(2, '0')}-${String(excelDate.d).padStart(2, '0')}`;
                    } else if (typeof dateValue === 'string') {
                        // Try to parse string date
                        const parsedDate = new Date(dateValue);
                        if (!isNaN(parsedDate)) {
                            formattedDate = parsedDate.toISOString().split('T')[0];
                        } else {
                            formattedDate = dateValue;
                        }
                            } else {
                        formattedDate = new Date().toISOString().split('T')[0];
                    }

                    // Parse description (column 1)
                    const description = row[1] ? String(row[1]).trim() : 'No description';

                    // Parse category (column 2)
                    const category = row[2] ? String(row[2]).trim() : 'Others';

                    // Parse amount (column 3)
                    let amount = parseFloat(row[3]);
                    if (isNaN(amount) || amount <= 0) {
                        console.warn(`Row ${i + 1}: Invalid amount, skipping`);
                        errorCount++;
                        continue;
                    }

                    // Create expense object
                    const expense = {
                        id: dailyExpenses.length + newExpenses.length + 1,
                        date: formattedDate,
                        description: description,
                        amount: amount,
                        type: 'daily',
                        category: category
                    };

                    newExpenses.push(expense);
                    successCount++;
                    
                } catch (error) {
                    console.error(`Error parsing row ${i + 1}:`, error);
                    errorCount++;
                }
            }

            // Append new expenses to the existing array
            if (newExpenses.length > 0) {
                dailyExpenses = [...dailyExpenses, ...newExpenses];
                
                // Reload the expenses table
                if (document.getElementById('expenses').classList.contains('hidden') === false) {
                    loadExpensesTable();
                }

                // Show success message
                showExcelUploadSuccess(successCount, errorCount, fileName);
                
                // Re-initialize Lucide icons
                lucide.createIcons();
            } else {
                alert('No valid expense entries found in the Excel file');
            }
        }

        // Show success notification
        function showExcelUploadSuccess(successCount, errorCount, fileName) {
            const dropZone = document.getElementById('excelDropZone');
            
            // Create success message element
            const successMsg = document.createElement('div');
            successMsg.className = 'excel-upload-success';
            successMsg.innerHTML = `
                <i data-lucide="check-circle" style="width: 20px; height: 20px;"></i>
                <div style="flex: 1;">
                    <strong>Upload Successful!</strong><br>
                    <span style="font-size: 13px; opacity: 0.9;">
                        ${successCount} expenses added from "${fileName}"
                        ${errorCount > 0 ? ` (${errorCount} rows skipped due to errors)` : ''}
                    </span>
                </div>
            `;
            
            // Insert before the drop zone
            dropZone.parentNode.insertBefore(successMsg, dropZone);
            
            // Re-initialize icons for the success message
            lucide.createIcons();
            
            // Remove success message after 5 seconds
            setTimeout(() => {
                successMsg.style.transition = 'opacity 0.3s ease';
                successMsg.style.opacity = '0';
                setTimeout(() => successMsg.remove(), 300);
            }, 5000);
        }
        
// ===== CLEANUP: Remove offensive message from localStorage =====
(function() {
    try {
        let m = JSON.parse(localStorage.getItem('indigoMessages') || '[]');
        m = m.filter(x => !(x.message && x.message.includes('nigga balls')));
        localStorage.setItem('indigoMessages', JSON.stringify(m));
        console.log('Cleaned up offensive message from localStorage');
    } catch (e) {
        console.log('Cleanup script error:', e);
    }
})();
    </script>
</body>
</html>
